(function($){typeof define=="function"&&define.amd?define($):$()})((function(){"use strict";function $(S){const I=20037508342789244e-9,x={};let m;const T=(l,t,c,i)=>l.replace("{z}",String(t)).replace("{x}",String(c)).replace("{y}",String(i)).replace("{-y}",String(Math.pow(2,t)-i-1)),R=(l,t="",c=512)=>{const i=atob(l),o=[];for(let a=0;a<i.length;a+=c){const e=i.slice(a,a+c),n=new Array(e.length);for(let A=0;A<e.length;A++)n[A]=e.charCodeAt(A);const s=new Uint8Array(n);o.push(s)}return new Blob(o,{type:t})},w=async(l,t,c)=>new Promise((i,o)=>{try{if(x[l])i(x[l]);else{const r=indexedDB.open(l);r.onupgradeneeded=function(a){const e=a.target.result;t&&c&&e.createObjectStore(t,{keyPath:c})},r.onsuccess=function(a){const e=a.target.result;x[l]=e,i(e)},r.onerror=function(a){o(r.error)}}}catch(r){o(r)}}),X=async l=>(x[l]&&(x[l].close(),delete x[l]),new Promise((t,c)=>{try{const i=indexedDB.deleteDatabase(l);i.onsuccess=async o=>{t()},i.onerror=function(o){c(o)}}catch(i){c(i)}})),B=async(l,t)=>new Promise((c,i)=>{const o=l.transaction([t],"readwrite"),a=o.objectStore(t).clear();a.onsuccess=function(e){},a.onerror=function(e){i(e)},o.oncomplete=function(e){c()},o.onabort=function(e){i(e)},o.onerror=function(e){i(e)}}),Y=async(l,t)=>new Promise((c,i)=>{const o=l.transaction([t],"readonly"),a=o.objectStore(t).openCursor();let e=0,n=0;a.onsuccess=function(s){const A=a.result;A&&(e++,n=n+A.value.blob.size,A.continue())},a.onerror=function(s){i(s)},o.oncomplete=function(s){c({count:e,size:n})},o.onabort=function(s){i(s)},o.onerror=function(s){i(s)}}),M=async(l,t,c,i)=>new Promise((o,r)=>{const a=l.transaction([t],"readonly"),e=a.objectStore(t),n=i?e.getKey(c):e.get(c);n.onsuccess=function(s){},n.onerror=function(s){r(s)},a.oncomplete=function(s){o(n.result)},a.onabort=function(s){r(s)},a.onerror=function(s){r(s)}}),E=async(l,t,c)=>new Promise((i,o)=>{const r=l.transaction([t],"readwrite"),e=r.objectStore(t).put(c);e.onsuccess=function(n){},e.onerror=function(n){o(n)},r.oncomplete=function(n){i()},r.onabort=function(n){o(n)},r.onerror=function(n){o(n)}}),C=async(l,t,c)=>new Promise((i,o)=>{const r=l.transaction([t],"readwrite"),e=r.objectStore(t).delete(c);e.onsuccess=function(n){},e.onerror=function(n){o(n)},r.oncomplete=function(n){i()},r.onabort=function(n){o(n)},r.onerror=function(n){o(n)}}),F=async(l,t)=>new Promise((c,i)=>{const o=l.transaction([t],"readwrite"),a=o.objectStore(t).getAllKeys();a.onsuccess=function(e){},a.onerror=function(e){i(e)},o.oncomplete=function(e){c(a.result)},o.onabort=function(e){i(e)},o.onerror=function(e){i(e)}}),P=async({url:l,event:t})=>{const c=t instanceof FetchEvent?t:void 0,i=c&&c.clientId?await self.clients.get(c.clientId):void 0,o=l.pathname.match(/^\/api\/([\w\d]+)(?:\/(.+))?$/);if(o){const r=[...l.searchParams.entries()].reduce((s,A)=>{const h=l.searchParams.getAll(A[0]);return h.length===1?s[A[0]]=h[0]:s[A[0]]=h,s},{}),a=o[1],e=o[2];let n=await k(a,r,e,i);if(n)return n instanceof Response||(n=new Response(n)),n}return new Response("Not Found",{status:404})},_=async(l,t,c,i,o)=>{let r;const a=await w("Weiwudi"),e=await M(a,"mapSetting",l);if(!o){if(!e)return`Error: MapID "${l}" not found`;if(t<(e.minZoom||0)||t>(e.maxZoom||0))r="zoom";else if(e.minX!==void 0&&e.maxX!==void 0&&e.minY!==void 0&&e.maxY!==void 0){const p=Math.pow(2,(e.maxZoom||0)-t),f=Math.floor((e.minX||0)/p),b=Math.floor((e.maxX||0)/p),g=Math.floor((e.minY||0)/p),u=Math.floor((e.maxY||0)/p);(c<f||c>b||i<g||i>u)&&(r="extent")}}let n={},s,A=200,h="OK";if(r)r==="zoom"?(A=404,h="Not Found"):(n={"content-type":"image/png"},s=R("iVBORw0KGgoAAAANSUhEUgAAAQAAAAEACAMAAABrrFhUAAAAB3RJTUUH3QgIBToaSbAjlwAAABd0RVh0U29mdHdhcmUAR0xEUE5HIHZlciAzLjRxhaThAAAACHRwTkdHTEQzAAAAAEqAKR8AAAAEZ0FNQQAAsY8L/GEFAAAAA1BMVEX///+nxBvIAAAAAXRSTlMAQObYZgAAAFRJREFUeNrtwQEBAAAAgJD+r+4ICgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABgBDwABHHIJwwAAAABJRU5ErkJggg==",n["content-type"]));else{const p=await w(`Weiwudi_${l}`),f=await M(p,"tileCache",`${t}_${c}_${i}`,o),b=new Date().getTime();if(!f||!f.epoch||b-f.epoch>864e5){let g="";e.url instanceof Array?g=e.url[Math.floor(Math.random()*e.url.length)]:typeof e.url=="string"&&(g=e.url);const u=T(g,t,c,i);try{const d=await fetch(u);d.ok?(n={},d.headers.forEach((D,Z)=>{n[Z]=D}),s=await d.blob(),await E(p,"tileCache",{z_x_y:`${t}_${c}_${i}`,headers:n,blob:s,epoch:b})):(f?(n=f.headers,s=f.blob):(A=d.status,h=d.statusText,n={},d.headers.forEach((D,Z)=>{n[Z]=D}),s=await d.blob()),m&&m.error++)}catch{f?(n=f.headers,s=f.blob):(A=404,h="Not Found"),m&&m.error++}}else o||(n=f.headers,s=f.blob)}return o?void 0:new Response(s,{status:A,statusText:h,headers:new Headers(n)})},L=async(l,t)=>{let c=0,i=0;const o=await w(`Weiwudi_${t.mapID}`),r=await F(o,"tileCache");try{const a=[],e=t.minZoom||0,n=t.maxZoom||0;for(let h=e;h<=n;h++){const p=Math.pow(2,n-h),f=Math.floor((t.maxX||0)/p),b=Math.floor((t.minX||0)/p),g=Math.floor((t.maxY||0)/p),u=Math.floor((t.minY||0)/p);for(let d=b;d<=f;d++)for(let D=u;D<=g;D++)a.push([h,d,D])}a.length!=t.totalTile&&console.log("Number of tiles is different");let s=a.splice(0,5);for(;s.length;){if(!await self.clients.get(l.id)){m=void 0;return}if(m&&m.cancel){m=void 0,l.postMessage({type:"canceled",message:`Fetching tile of ${t.mapID} is canceled`,mapID:t.mapID});return}const p=s.map(f=>{if(!(r.indexOf(`${f[0]}_${f[1]}_${f[2]}`)>=0))return _(t.mapID,f[0],f[1],f[2],!0)});await Promise.all(p),c+=p.length,m&&(m.count=c),i=Math.floor(c*100/(t.totalTile||1)),l.postMessage({type:"proceed",message:`Proceeding the tile fetching: ${t.mapID} ${i}% (${c} / ${t.totalTile})`,percent:i,processed:c,error:m?m.error:0,total:t.totalTile,mapID:t.mapID}),s=a.splice(0,5)}const A=m?m.error:0;m=void 0,l.postMessage({type:"finish",message:`Fetched all tiles of ${t.mapID}${A?` with ${A} error cases`:""}`,total:t.totalTile,mapID:t.mapID,error:A})}catch(a){m=void 0,l.postMessage({type:"stop",message:`Fetching stopped: ${t.mapID} ${c} / ${t.totalTile}`,reason:a,processed:c,total:t.totalTile,mapID:t.mapID})}},k=async(l,t,c,i)=>{let o;const r=(a,e)=>e.reduce((n,s)=>n||(a[s]===void 0?`Error: Attribute "${s}" is missing`:n),void 0);try{switch(l){case"ping":o="Implemented";break;case"info":if(o=r(t,["mapID"]),!o){const a=await w("Weiwudi","mapSetting","mapID"),e=await M(a,"mapSetting",t.mapID);e?o=new Response(JSON.stringify(e),{headers:new Headers({"content-type":"application/json"})}):o=`Error: MapID "${t.mapID}" not found`}break;case"add":{const a=await w("Weiwudi","mapSetting","mapID");if(o=r(t,["mapID","type","url"]),!o)switch(t.tileSize=parseInt(t.tileSize||256),t.type){case"xyz":if(o=r(t,["width","height"]),!o){t.width=parseInt(t.width),t.height=parseInt(t.height);const e=n=>Math.ceil(Math.log(n/t.tileSize)/Math.log(2));t.maxZoom=Math.max(e(t.width),e(t.height)),t.minZoom=t.minZoom?parseInt(t.minZoom):0,t.minX=0,t.minY=0,t.maxX=Math.ceil(t.width/t.tileSize)-1,t.maxY=Math.ceil(t.height/t.tileSize)-1}break;case"wmts":if(!o){const e=s=>6378137*s*Math.PI/180,n=s=>6378137*Math.log(Math.tan(Math.PI/360*(90+s)));if(t.maxZoom&&(t.maxZoom=parseInt(t.maxZoom)),t.minZoom&&(t.minZoom=parseInt(t.minZoom)),t.maxLng&&t.minLng&&t.maxLat&&t.minLat){t.maxLng=parseFloat(t.maxLng),t.minLng=parseFloat(t.minLng),t.maxLat=parseFloat(t.maxLat),t.minLat=parseFloat(t.minLat);const s=e(t.maxLng),A=e(t.minLng),h=n(t.maxLat),p=n(t.minLat);t.minX=Math.floor((I+A)/(2*I)*Math.pow(2,t.maxZoom)),t.maxX=Math.floor((I+s)/(2*I)*Math.pow(2,t.maxZoom)),t.minY=Math.floor((I-h)/(2*I)*Math.pow(2,t.maxZoom)),t.maxY=Math.floor((I-p)/(2*I)*Math.pow(2,t.maxZoom))}}break;default:o='Error: Unknown "type" value'}if(!o){if(!r(t,["maxX","minX","maxY","minY","minZoom","maxZoom"])){t.totalTile=0;const e=(n,s)=>Math.floor(n/Math.pow(2,t.maxZoom-s));for(let n=t.minZoom;n<=t.maxZoom;n++){const s=e(t.minX,n),A=e(t.minY,n),h=e(t.maxX,n),p=e(t.maxY,n);t.totalTile+=(h-s+1)*(p-A+1)}}await E(a,"mapSetting",t),await w(`Weiwudi_${t.mapID}`,"tileCache","z_x_y"),o=new Response(JSON.stringify(t),{headers:new Headers({"content-type":"application/json"})})}break}case"clean":if(o=r(t,["mapID"]),m&&m.mapID==t.mapID)o=`Error: ${t.mapID} is under fetching process. Please cancel it first`;else if(!o){const a=await w(`Weiwudi_${t.mapID}`);await B(a,"tileCache"),o=`Cleaned: ${t.mapID}`}break;case"delete":if(o=r(t,["mapID"]),m&&m.mapID==t.mapID)o=`Error: ${t.mapID} is under fetching process. Please cancel it first`;else if(!o){await X(`Weiwudi_${t.mapID}`);const a=await w("Weiwudi");await C(a,"mapSetting",t.mapID),o=`Deleted: ${t.mapID}`}break;case"cancel":o=r(t,["mapID"]),m&&m.mapID==t.mapID?(m.cancel=!0,o=`Fetching process of ${m.mapID} is canceled`):o=`Error: There are no fetching process of ${t.mapID}`;break;case"stats":if(o=r(t,["mapID"]),!o){const a=await w("Weiwudi"),e=await M(a,"mapSetting",t.mapID);if(!e)o=`Error: MapID "${t.mapID}" not found`;else{const n=await w(`Weiwudi_${t.mapID}`),s=await Y(n,"tileCache");e.totalTile&&(s.total=e.totalTile,s.percent=Math.floor(s.count/s.total*100)),o=new Response(JSON.stringify(s),{headers:new Headers({"content-type":"application/json"})})}}break;case"cache":{const a=c?.match(/^([^/]+)\/(\d+)\/(\d+)\/(\d+)$/);a?o=await _(a[1],parseInt(a[2]),parseInt(a[3]),parseInt(a[4])):o='Error: "cache" api needs mapID, zoom, x, y settings';break}case"fetchAll":if(o=r(t,["mapID"]),!o&&i){const a=await w("Weiwudi"),e=await M(a,"mapSetting",t.mapID);e?e.totalTile?m?o=`Error: Another fetching process is running: "${m.mapID}" (${m.count} / ${m.total})`:(setTimeout(()=>{m={mapID:t.mapID,total:e.totalTile||0,count:0,error:0},L(i,e)},1),o=`Fetching task start: ${t.mapID}`):o=`Error: Map "${t.mapID}" cannot fetch all tiles`:o=`Error: MapID "${t.mapID}" not found`}break;default:o=`Error: API ${l} not found`}}catch(a){o=`Error: ${a}`}if(o)return o};S(/^https?:\/\/weiwudi.example.com/,P,"GET")}$(self.workbox.routing.registerRoute)}));
//# sourceMappingURL=weiwudi-sw.umd.js.map
