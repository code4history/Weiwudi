(function(b,M){typeof exports=="object"&&typeof module<"u"?M(require("workbox-routing")):typeof define=="function"&&define.amd?define(["workbox-routing"],M):(b=typeof globalThis<"u"?globalThis:b||self,M(b.workboxRouting))})(this,(function(b){"use strict";function M(R){const w=20037508342789244e-9,D={};let p;const B=(r,t,l,i)=>r.replace("{z}",t).replace("{x}",l).replace("{y}",i).replace("{-y}",Math.pow(2,t)-i-1),S=(r,t="",l=512)=>{const i=atob(r),o=[];for(let a=0;a<i.length;a+=l){const e=i.slice(a,a+l),n=new Array(e.length);for(let m=0;m<e.length;m++)n[m]=e.charCodeAt(m);const s=new Uint8Array(n);o.push(s)}return new Blob(o,{type:t})},d=async(r,t,l)=>new Promise((i,o)=>{try{if(D[r])i(D[r]);else{const c=indexedDB.open(r);c.onupgradeneeded=function(a){a.target.result.createObjectStore(t,{keyPath:l})},c.onsuccess=function(a){const e=a.target.result;D[r]=e,i(e)},c.onerror=function(a){o(a)}}}catch(c){o(c)}}),X=async r=>(D[r]&&(D[r].close(),delete D[r]),new Promise((t,l)=>{try{const i=indexedDB.deleteDatabase(r);i.onsuccess=async o=>{t()},i.onerror=function(o){l(o)}}catch(i){l(i)}})),Y=async(r,t)=>new Promise((l,i)=>{const o=r.transaction([t],"readwrite"),a=o.objectStore(t).clear();a.onsuccess=function(e){},a.onerror=function(e){i(e)},o.oncomplete=function(e){l()},o.onabort=function(e){i(e)},o.onerror=function(e){i(e)}}),k=async(r,t)=>new Promise((l,i)=>{const o=r.transaction([t],"readonly"),a=o.objectStore(t).openCursor();let e=0,n=0;a.onsuccess=function(s){const m=a.result;m&&(e++,n=n+m.value.blob.size,m.continue())},a.onerror=function(s){i(s)},o.oncomplete=function(s){l({count:e,size:n})},o.onabort=function(s){i(s)},o.onerror=function(s){i(s)}}),u=async(r,t,l,i)=>new Promise((o,c)=>{const a=r.transaction([t],"readonly"),e=a.objectStore(t),n=i?e.getKey(l):e.get(l);n.onsuccess=function(s){},n.onerror=function(s){c(s)},a.oncomplete=function(s){o(n.result)},a.onabort=function(s){c(s)},a.onerror=function(s){c(s)}}),T=async(r,t,l)=>new Promise((i,o)=>{const c=r.transaction([t],"readwrite"),e=c.objectStore(t).put(l);e.onsuccess=function(n){},e.onerror=function(n){o(n)},c.oncomplete=function(n){i()},c.onabort=function(n){o(n)},c.onerror=function(n){o(n)}}),C=async(r,t,l)=>new Promise((i,o)=>{const c=r.transaction([t],"readwrite"),e=c.objectStore(t).delete(l);e.onsuccess=function(n){},e.onerror=function(n){o(n)},c.oncomplete=function(n){i()},c.onabort=function(n){o(n)},c.onerror=function(n){o(n)}}),P=async(r,t)=>new Promise((l,i)=>{const o=r.transaction([t],"readwrite"),a=o.objectStore(t).getAllKeys();a.onsuccess=function(e){},a.onerror=function(e){i(e)},o.oncomplete=function(e){l(a.result)},o.onabort=function(e){i(e)},o.onerror=function(e){i(e)}}),_=async({url:r,request:t,event:l,_params:i})=>{const o=l.clientId?await self.clients.get(l.clientId):void 0,c=r.pathname.match(/^\/api\/([\w\d]+)(?:\/(.+))?$/);if(c){const a=[...r.searchParams.entries()].reduce((m,A)=>{const h=r.searchParams.getAll(A[0]);return h.length===1?m[A[0]]=h[0]:m[A[0]]=h,m},{}),e=c[1],n=c[2];let s=await F(e,a,n,o);if(s)return s instanceof Response||(s=new Response(s)),s}},E=async(r,t,l,i,o)=>{let c;const a=await d("Weiwudi"),e=await u(a,"mapSetting",r);if(!o){if(!e)return`Error: MapID "${r}" not found`;if(t<e.minZoom||t>e.maxZoom)c="zoom";else{const h=Math.floor(e.minX/Math.pow(2,e.maxZoom-t)),f=Math.floor(e.maxX/Math.pow(2,e.maxZoom-t)),I=Math.floor(e.minY/Math.pow(2,e.maxZoom-t)),g=Math.floor(e.maxY/Math.pow(2,e.maxZoom-t));(l<h||l>f||i<I||i>g)&&(c="extent")}}let n={},s,m=200,A="OK";if(c)c==="zoom"?(m=404,A="Not Found"):(n={"content-type":"image/png"},s=S("iVBORw0KGgoAAAANSUhEUgAAAQAAAAEACAMAAABrrFhUAAAAB3RJTUUH3QgIBToaSbAjlwAAABd0RVh0U29mdHdhcmUAR0xEUE5HIHZlciAzLjRxhaThAAAACHRwTkdHTEQzAAAAAEqAKR8AAAAEZ0FNQQAAsY8L/GEFAAAAA1BMVEX///+nxBvIAAAAAXRSTlMAQObYZgAAAFRJREFUeNrtwQEBAAAAgJD+r+4ICgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABgBDwABHHIJwwAAAABJRU5ErkJggg==",n["content-type"]));else{const h=await d(`Weiwudi_${r}`),f=await u(h,"tileCache",`${t}_${l}_${i}`,o),I=new Date().getTime();if(!f||!f.epoch||I-f.epoch>864e5){const g=e.url instanceof Array?e.url[Math.floor(Math.random()*e.url.length)]:e.url,W=B(g,t,l,i);try{const x=await fetch(W);x.ok?(n=[...x.headers.entries()].reduce((Z,$)=>({...Z,[$[0]]:$[1]}),{}),s=await x.blob(),await T(h,"tileCache",{z_x_y:`${t}_${l}_${i}`,headers:n,blob:s,epoch:I})):(f?(n=f.headers,s=f.blob):(m=x.status,A=x.statusText,n=[...x.headers.entries()].reduce((Z,$)=>({...Z,[$[0]]:$[1]}),{}),s=await x.blob()),p&&p.error++)}catch{f?(n=f.headers,s=f.blob):(m=404,A="Not Found"),p&&p.error++}}else o||(n=f.headers,s=f.blob)}return o?void 0:new Response(s,{status:m,statusText:A,headers:new Headers(n)})},L=async(r,t)=>{let l=0,i=0;const o=await d(`Weiwudi_${t.mapID}`),c=await P(o,"tileCache");try{const a=[];for(let s=t.minZoom;s<=t.maxZoom;s++){const m=Math.floor(t.maxX/Math.pow(2,t.maxZoom-s)),A=Math.floor(t.minX/Math.pow(2,t.maxZoom-s)),h=Math.floor(t.maxY/Math.pow(2,t.maxZoom-s)),f=Math.floor(t.minY/Math.pow(2,t.maxZoom-s));for(let I=A;I<=m;I++)for(let g=f;g<=h;g++)a.push([s,I,g])}a.length!=t.totalTile&&console.log("Number of tiles is different");let e=a.splice(0,5);for(;e.length;){if(!await self.clients.get(r.id)){p=void 0;return}if(p.cancel){p=void 0,r.postMessage({type:"canceled",message:`Fetching tile of ${t.mapID} is canceled`,mapID:t.mapID});return}const m=e.map(A=>{if(!(c.indexOf(`${A[0]}_${A[1]}_${A[2]}`)>=0))return E(t.mapID,A[0],A[1],A[2],!0)});await Promise.all(m),l+=m.length,p.count=l,i=Math.floor(l*100/t.totalTile),r.postMessage({type:"proceed",message:`Proceeding the tile fetching: ${t.mapID} ${i}% (${l} / ${t.totalTile})`,percent:i,processed:l,error:p.error,total:t.totalTile,mapID:t.mapID}),e=a.splice(0,5)}const n=p.error;p=void 0,r.postMessage({type:"finish",message:`Fetched all tiles of ${t.mapID}${n?` with ${n} error cases`:""}`,total:t.totalTile,mapID:t.mapID,error:n})}catch(a){p=void 0,r.postMessage({type:"stop",message:`Fetching stopped: ${t.mapID} ${l} / ${t.totalTile}`,reason:a,processed:l,total:t.totalTile,mapID:t.mapID})}},F=async(r,t,l,i)=>{let o;const c=(a,e)=>e.reduce((n,s)=>n||(a[s]===void 0?`Error: Attribute "${s}" is missing`:n),void 0);try{switch(r){case"ping":o="Implemented";break;case"info":if(o=c(t,["mapID"]),!o){const a=await d("Weiwudi","mapSetting","mapID"),e=await u(a,"mapSetting",t.mapID);e?o=new Response(JSON.stringify(e),{headers:new Headers({"content-type":"application/json"})}):o=`Error: MapID "${t.mapID}" not found`}break;case"add":{const a=await d("Weiwudi","mapSetting","mapID");if(o=c(t,["mapID","type","url"]),!o)switch(t.tileSize=parseInt(t.tileSize||256),t.type){case"xyz":if(o=c(t,["width","height"]),!o){t.width=parseInt(t.width),t.height=parseInt(t.height);const e=n=>Math.ceil(Math.log(n/t.tileSize)/Math.log(2));t.maxZoom=Math.max(e(t.width),e(t.height)),t.minZoom=t.minZoom?parseInt(t.minZoom):0,t.minX=0,t.minY=0,t.maxX=Math.ceil(t.width/t.tileSize)-1,t.maxY=Math.ceil(t.height/t.tileSize)-1}break;case"wmts":if(!o){const e=s=>6378137*s*Math.PI/180,n=s=>6378137*Math.log(Math.tan(Math.PI/360*(90+s)));if(t.maxZoom&&(t.maxZoom=parseInt(t.maxZoom)),t.minZoom&&(t.minZoom=parseInt(t.minZoom)),t.maxLng&&t.minLng&&t.maxLat&&t.minLat){t.maxLng=parseFloat(t.maxLng),t.minLng=parseFloat(t.minLng),t.maxLat=parseFloat(t.maxLat),t.minLat=parseFloat(t.minLat);const s=e(t.maxLng),m=e(t.minLng),A=n(t.maxLat),h=n(t.minLat);t.minX=Math.floor((w+m)/(2*w)*Math.pow(2,t.maxZoom)),t.maxX=Math.floor((w+s)/(2*w)*Math.pow(2,t.maxZoom)),t.minY=Math.floor((w-A)/(2*w)*Math.pow(2,t.maxZoom)),t.maxY=Math.floor((w-h)/(2*w)*Math.pow(2,t.maxZoom))}}break;default:o='Error: Unknown "type" value'}if(!o){if(!c(t,["maxX","minX","maxY","minY","minZoom","maxZoom"])){t.totalTile=0;const e=(n,s)=>Math.floor(n/Math.pow(2,t.maxZoom-s));for(let n=t.minZoom;n<=t.maxZoom;n++){const s=e(t.minX,n),m=e(t.minY,n),A=e(t.maxX,n),h=e(t.maxY,n);t.totalTile+=(A-s+1)*(h-m+1)}}await T(a,"mapSetting",t),await d(`Weiwudi_${t.mapID}`,"tileCache","z_x_y"),o=new Response(JSON.stringify(t),{headers:new Headers({"content-type":"application/json"})})}break}case"clean":if(o=c(t,["mapID"]),p&&p.mapID==t.mapID)o=`Error: ${t.mapID} is under fetching process. Please cancel it first`;else if(!o){const a=await d(`Weiwudi_${t.mapID}`);await Y(a,"tileCache"),o=`Cleaned: ${t.mapID}`}break;case"delete":if(o=c(t,["mapID"]),p&&p.mapID==t.mapID)o=`Error: ${t.mapID} is under fetching process. Please cancel it first`;else if(!o){await X(`Weiwudi_${t.mapID}`);const a=await d("Weiwudi");await C(a,"mapSetting",t.mapID),o=`Deleted: ${t.mapID}`}break;case"cancel":o=c(t,["mapID"]),p&&p.mapID==t.mapID?(p.cancel=!0,o=`Fetching process of ${p.mapID} is canceled`):o=`Error: There are no fetching process of ${t.mapID}`;break;case"stats":if(o=c(t,["mapID"]),!o){const a=await d("Weiwudi"),e=await u(a,"mapSetting",t.mapID);if(!e)o=`Error: MapID "${t.mapID}" not found`;else{const n=await d(`Weiwudi_${t.mapID}`),s=await k(n,"tileCache");e.totalTile&&(s.total=e.totalTile,s.percent=Math.floor(s.count/s.total*100)),o=new Response(JSON.stringify(s),{headers:new Headers({"content-type":"application/json"})})}}break;case"cache":{const a=l.match(/^([^/]+)\/(\d+)\/(\d+)\/(\d+)$/);a?o=await E(a[1],parseInt(a[2]),parseInt(a[3]),parseInt(a[4])):o='Error: "cache" api needs mapID, zoom, x, y settings';break}case"fetchAll":if(o=c(t,["mapID"]),!o){const a=await d("Weiwudi"),e=await u(a,"mapSetting",t.mapID);e?e.totalTile?p?o=`Error: Another fetching process is running: "${p.mapID}" (${p.count} / ${p.total})`:(setTimeout(()=>{p={mapID:t.mapID,total:e.totalTile,count:0,error:0},L(i,e)},1),o=`Fetching task start: ${t.mapID}`):o=`Error: Map "${t.mapID}" cannot fetch all tiles`:o=`Error: MapID "${t.mapID}" not found`}break;default:o=`Error: API ${r} not found`}}catch(a){o=`Error: ${a}`}if(o)return o};R(/^https?:\/\/weiwudi.example.com/,_,"GET")}M(b.registerRoute)}));
//# sourceMappingURL=weiwudi-sw.umd.js.map
