{"version":3,"file":"weiwudi.umd.js","sources":["../src/weiwudi.ts"],"sourcesContent":["\"use strict\";\r\n\r\nconst BASEURL = 'https://weiwudi.example.com/api/';\r\nlet swChecking: Promise<boolean> | undefined;\r\nlet swChecked: boolean | undefined;\r\n\r\n// Polyfill removed as target is ES2020\r\n\r\nexport class WeiwudiEventTarget {\r\n    listeners: Record<string, ((...args: unknown[]) => void)[]>;\r\n\r\n    constructor() {\r\n        this.listeners = {};\r\n    }\r\n\r\n    addEventListener(type: string, callback: (...args: unknown[]) => void) {\r\n        if (!(type in this.listeners)) {\r\n            this.listeners[type] = [];\r\n        }\r\n        this.listeners[type].push(callback);\r\n    }\r\n\r\n    removeEventListener(type: string, callback: (...args: unknown[]) => void) {\r\n        if (!(type in this.listeners)) {\r\n            return;\r\n        }\r\n        const stack = this.listeners[type];\r\n        for (let i = 0, l = stack.length; i < l; i++) {\r\n            if (stack[i] === callback) {\r\n                stack.splice(i, 1);\r\n                return;\r\n            }\r\n        }\r\n    }\r\n\r\n    dispatchEvent(event: Event | CustomEvent) {\r\n        if (!(event.type in this.listeners)) {\r\n            return true;\r\n        }\r\n        const stack = this.listeners[event.type].slice();\r\n\r\n        for (let i = 0, l = stack.length; i < l; i++) {\r\n            stack[i].call(this, event);\r\n        }\r\n        return !event.defaultPrevented;\r\n    }\r\n}\r\n\r\nexport interface WeiwudiOptions {\r\n    type?: string;\r\n    url?: string;\r\n    width?: number;\r\n    height?: number;\r\n    tileSize?: number;\r\n    minZoom?: number;\r\n    maxZoom?: number;\r\n    maxLng?: number;\r\n    maxLat?: number;\r\n    minLng?: number;\r\n    minLat?: number;\r\n    [key: string]: unknown;\r\n}\r\n\r\nexport interface WeiwudiInternalOps {\r\n    // Placeholder for future strict typing of internal operations\r\n    [key: string]: unknown;\r\n}\r\n\r\nexport default class Weiwudi extends WeiwudiEventTarget {\r\n    mapID?: string;\r\n    url?: string;\r\n    listener: (e: MessageEvent) => void;\r\n\r\n    static async registerSW(sw: string | URL, swOptions?: RegistrationOptions) {\r\n        if ('serviceWorker' in navigator) {\r\n            try {\r\n                const reg = await navigator.serviceWorker.register(sw, swOptions);\r\n                //console.log('Service Worker Registered');\r\n\r\n                // A wild service worker has appeared in reg.installing and maybe in waiting!\r\n                const newWorker = reg.installing;\r\n                const waitingWoker = reg.waiting;\r\n\r\n                if (newWorker) {\r\n                    if (newWorker.state === 'activated' && !waitingWoker) {\r\n                        // reload to avoid skipWaiting and clients.claim()\r\n                        window.location.reload();\r\n                    }\r\n                    newWorker.addEventListener('statechange', (_e) => {\r\n                        // newWorker.state has changed\r\n                        if (newWorker.state === 'activated' && !waitingWoker) {\r\n                            // reload to avoid skipWaiting and clients.claim()\r\n                            window.location.reload();\r\n                        }\r\n                    });\r\n                }\r\n                reg.onupdatefound = () => {\r\n                    //console.log('Found Service Worker update');\r\n                    reg.update();\r\n                };\r\n\r\n                await Weiwudi.swCheck();\r\n\r\n                return reg;\r\n            } catch (e) {\r\n                throw (`Error: Service worker registration failed with ${e}`);\r\n            }\r\n        } else {\r\n            throw ('Error: Service worker is not supported');\r\n        }\r\n    }\r\n\r\n    static async swCheck() {\r\n        if (swChecked !== undefined) return swChecked;\r\n        if (swChecking === undefined) swChecking = new Promise((res, _rej) => {\r\n            // Removing async from executor and handling promise explicitly if needed, \r\n            // but here the code was wrapping await in a new Promise which is antipattern.\r\n            // We can just rely on correct async flow or keep simpler.\r\n            // Given logic:\r\n            fetch(`${BASEURL}ping`)\r\n                .then(r => {\r\n                    swChecked = !!r;\r\n                    res(swChecked);\r\n                })\r\n                .catch(_e => {\r\n                    swChecked = false;\r\n                    res(swChecked);\r\n                });\r\n        });\r\n        return swChecking;\r\n    }\r\n\r\n    static async registerMap(mapID: string, options: WeiwudiOptions) {\r\n        const swCheck = await Weiwudi.swCheck();\r\n        if (!swCheck) throw ('Weiwudi service worker is not implemented.');\r\n        let text;\r\n        const p = ['type', 'url', 'width', 'height', 'tileSize', 'minZoom', 'maxZoom', 'maxLng', 'maxLat', 'minLng', 'minLat'].reduce((p, key) => {\r\n            if (typeof options[key] !== 'undefined') {\r\n                if (options[key] instanceof Array) {\r\n                    options[key].map((val: string) => {\r\n                        p.append(key, val);\r\n                    });\r\n                } else {\r\n                    p.append(key, String(options[key]));\r\n                }\r\n            }\r\n            return p;\r\n        }, new URLSearchParams());\r\n        p.append('mapID', mapID);\r\n        const url = new URL(`${BASEURL}add`);\r\n        url.search = p.toString(); // URLSearchParams to string\r\n        const res = await fetch(url.href);\r\n        text = await res.text();\r\n        if (text.match(/^Error: /)) {\r\n            throw (text);\r\n        }\r\n        return new Weiwudi(mapID, JSON.parse(text));\r\n    }\r\n\r\n    static async retrieveMap(mapID: string) {\r\n        const swCheck = await Weiwudi.swCheck();\r\n        if (!swCheck) throw ('Weiwudi service worker is not implemented.');\r\n        let text;\r\n        const res = await fetch(`${BASEURL}info?mapID=${mapID}`);\r\n        text = await res.text();\r\n        if (text.match(/^Error: /)) {\r\n            throw (text);\r\n        }\r\n        console.log(text);\r\n        return new Weiwudi(mapID, JSON.parse(text));\r\n    }\r\n\r\n    static async removeMap(mapID: string) {\r\n        const swCheck = await Weiwudi.swCheck();\r\n        if (!swCheck) throw ('Weiwudi service worker is not implemented.');\r\n        let text;\r\n        const res = await fetch(`${BASEURL}delete?mapID=${mapID}`);\r\n        text = await res.text();\r\n        if (text.match(/^Error: /)) {\r\n            throw (text);\r\n        }\r\n    }\r\n\r\n    constructor(mapID: string, attrs?: WeiwudiOptions) {\r\n        super();\r\n        if (!mapID) throw ('MapID is necessary.');\r\n        this.mapID = mapID;\r\n        if (attrs) Object.assign(this, attrs);\r\n        this.url = `${BASEURL}cache/${mapID}/{z}/{x}/{y}`;\r\n        this.listener = (e: MessageEvent) => {\r\n            const eventMapID = e.data.mapID;\r\n            if (eventMapID !== mapID) return;\r\n            this.dispatchEvent(new CustomEvent(e.data.type, { detail: e.data }));\r\n        };\r\n        navigator.serviceWorker.addEventListener('message', this.listener);\r\n    }\r\n\r\n    release() {\r\n        navigator.serviceWorker.removeEventListener('message', this.listener);\r\n        delete this.mapID;\r\n    }\r\n\r\n    checkAspect() {\r\n        if (!this.mapID) throw ('This instance is already released.');\r\n    }\r\n\r\n    async stats() {\r\n        let text;\r\n        this.checkAspect();\r\n        const res = await fetch(`${BASEURL}stats?mapID=${this.mapID}`);\r\n        text = await res.text();\r\n        if (typeof text === 'string' && text.match(/^Error: /)) {\r\n            throw (text);\r\n        }\r\n        return JSON.parse(text);\r\n    }\r\n\r\n    async clean() {\r\n        let text;\r\n        this.checkAspect();\r\n        const res = await fetch(`${BASEURL}clean?mapID=${this.mapID}`);\r\n        text = await res.text();\r\n        if (text.match(/^Error: /)) {\r\n            throw (text);\r\n        }\r\n    }\r\n\r\n    async fetchAll() {\r\n        let text;\r\n        this.checkAspect();\r\n        const res = await fetch(`${BASEURL}fetchAll?mapID=${this.mapID}`);\r\n        text = await res.text();\r\n        if (text.match(/^Error: /)) {\r\n            throw (text);\r\n        }\r\n    }\r\n\r\n    async remove() {\r\n        this.checkAspect();\r\n        if (this.mapID) await Weiwudi.removeMap(this.mapID);\r\n        this.release();\r\n    }\r\n\r\n    async cancel() {\r\n        let text;\r\n        this.checkAspect();\r\n        const res = await fetch(`${BASEURL}cancel?mapID=${this.mapID}`);\r\n        text = await res.text();\r\n        if (text.match(/^Error: /)) {\r\n            throw (text);\r\n        }\r\n    }\r\n}"],"names":["BASEURL","swChecking","swChecked","WeiwudiEventTarget","type","callback","stack","l","event","i","Weiwudi","sw","swOptions","reg","newWorker","waitingWoker","_e","e","res","_rej","r","mapID","options","text","p","key","val","url","attrs"],"mappings":"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"}