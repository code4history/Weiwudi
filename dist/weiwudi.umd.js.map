{"version":3,"file":"weiwudi.umd.js","sources":["../src/weiwudi.js"],"sourcesContent":["\"use strict\";\r\n\r\nconst BASEURL = 'https://weiwudi.example.com/api/';\r\nlet swChecking;\r\nlet swChecked;\r\n\r\n(function () {\r\n    if (typeof window.CustomEvent === 'function') return false;\r\n\r\n    function CustomEvent(event, params) {\r\n        params = params || { bubbles: false, cancelable: false, detail: undefined };\r\n        var evt = document.createEvent('CustomEvent');\r\n        evt.initCustomEvent(event, params.bubbles, params.cancelable, params.detail);\r\n        return evt;\r\n    }\r\n\r\n    CustomEvent.prototype = window.Event.prototype;\r\n\r\n    window.CustomEvent = CustomEvent;\r\n})();\r\n\r\nclass EventTarget {\r\n    constructor() {\r\n        this.listeners = {};\r\n    }\r\n\r\n    addEventListener(type, callback) {\r\n        if (!(type in this.listeners)) {\r\n            this.listeners[type] = [];\r\n        }\r\n        this.listeners[type].push(callback);\r\n    }\r\n\r\n    removeEventListener(type, callback) {\r\n        if (!(type in this.listeners)) {\r\n            return;\r\n        }\r\n        const stack = this.listeners[type];\r\n        for (let i = 0, l = stack.length; i < l; i++) {\r\n            if (stack[i] === callback){\r\n                stack.splice(i, 1);\r\n                return;\r\n            }\r\n        }\r\n    }\r\n\r\n    dispatchEvent(event) {\r\n        if (!(event.type in this.listeners)) {\r\n            return true;\r\n        }\r\n        const stack = this.listeners[event.type].slice();\r\n\r\n        for (let i = 0, l = stack.length; i < l; i++) {\r\n            stack[i].call(this, event);\r\n        }\r\n        return !event.defaultPrevented;\r\n    }\r\n}\r\n\r\nexport default class Weiwudi extends EventTarget {\r\n    static async registerSW(sw, swOptions) {\r\n        if ('serviceWorker' in navigator) {\r\n            try {\r\n                const reg = await navigator.serviceWorker.register(sw, swOptions);\r\n                //console.log('Service Worker Registered');\r\n\r\n                // A wild service worker has appeared in reg.installing and maybe in waiting!\r\n                const newWorker = reg.installing;\r\n                const waitingWoker = reg.waiting;\r\n\r\n                if (newWorker) {\r\n                    if (newWorker.state === 'activated' && !waitingWoker) {\r\n                        // reload to avoid skipWaiting and clients.claim()\r\n                        window.location.reload();\r\n                    }\r\n                    newWorker.addEventListener('statechange', (e) => {\r\n                        // newWorker.state has changed\r\n                        if (newWorker.state === 'activated' && !waitingWoker) {\r\n                            // reload to avoid skipWaiting and clients.claim()\r\n                            window.location.reload();\r\n                        }\r\n                    });\r\n                }\r\n                reg.onupdatefound = () => {\r\n                    //console.log('Found Service Worker update');\r\n                    reg.update();\r\n                };\r\n\r\n                await Weiwudi.swCheck();\r\n\r\n                return reg;\r\n            } catch(e) {\r\n                throw(`Error: Service worker registration failed with ${e}`);\r\n            }\r\n        } else {\r\n            throw('Error: Service worker is not supported');\r\n        }\r\n    }\r\n\r\n    static async swCheck() {\r\n        if (swChecked !== undefined) return swChecked;\r\n        if (swChecking === undefined) swChecking = new Promise(async (res, rej) => {\r\n            try {\r\n                swChecked = await fetch(`${BASEURL}ping`);\r\n                swChecked = !!swChecked;\r\n            } catch(e) {\r\n                swChecked = false;\r\n            }\r\n            res(swChecked);\r\n        });\r\n        return swChecking;\r\n    }\r\n\r\n    static async registerMap(mapID, options) {\r\n        const swCheck = await Weiwudi.swCheck();\r\n        if (!swCheck) throw('Weiwudi service worker is not implemented.');\r\n        let text;\r\n        try {\r\n            const p = ['type', 'url', 'width', 'height', 'tileSize', 'minZoom', 'maxZoom', 'maxLng', 'maxLat', 'minLng', 'minLat'].reduce((p, key) => {\r\n                if (typeof options[key] !== 'undefined') {\r\n                    if (options[key] instanceof Array) {\r\n                        options[key].map((val) => {\r\n                            p.append(key, val);\r\n                        });\r\n                    } else {\r\n                        p.append(key, options[key]);\r\n                    }\r\n                }\r\n                return p;\r\n            }, new URLSearchParams());\r\n            p.append('mapID', mapID);\r\n            const url = new URL(`${BASEURL}add`);\r\n            url.search = p;\r\n            const res = await fetch(url.href);\r\n            text = await res.text();\r\n        } catch(e) {\r\n            throw(e);\r\n        }\r\n        if (text.match(/^Error: /)) {\r\n            throw(text);\r\n        }\r\n        return new Weiwudi(mapID, JSON.parse(text));\r\n    }\r\n\r\n    static async retrieveMap(mapID) {\r\n        const swCheck = await Weiwudi.swCheck();\r\n        if (!swCheck) throw('Weiwudi service worker is not implemented.');\r\n        let text;\r\n        try {\r\n            const res = await fetch(`${BASEURL}info?mapID=${mapID}`);\r\n            text = await res.text();\r\n        } catch(e) {\r\n            throw(e);\r\n        }\r\n        if (text.match(/^Error: /)) {\r\n            throw(text);\r\n        }\r\n        console.log(text);\r\n        return new Weiwudi(mapID, JSON.parse(text));\r\n    }\r\n\r\n    static async removeMap(mapID) {\r\n        const swCheck = await Weiwudi.swCheck();\r\n        if (!swCheck) throw('Weiwudi service worker is not implemented.');\r\n        let text;\r\n        try {\r\n            const res = await fetch(`${BASEURL}delete?mapID=${mapID}`);\r\n            text = await res.text();\r\n        } catch(e) {\r\n            throw(e);\r\n        }\r\n        if (text.match(/^Error: /)) {\r\n            throw(text);\r\n        }\r\n    }\r\n\r\n    constructor(mapID, attrs) {\r\n        super();\r\n        if (!mapID) throw('MapID is necessary.');\r\n        this.mapID = mapID;\r\n        if (attrs) Object.assign(this, attrs);\r\n        this.url = `${BASEURL}cache/${mapID}/{z}/{x}/{y}`;\r\n        this.listener = (e) => {\r\n            const eventMapID = e.data.mapID;\r\n            if (eventMapID !== mapID) return;\r\n            this.dispatchEvent(new CustomEvent(e.data.type, {detail: e.data}));\r\n        };\r\n        navigator.serviceWorker.addEventListener('message', this.listener);\r\n    }\r\n\r\n    release() {\r\n        navigator.serviceWorker.removeEventListener('message', this.listener);\r\n        delete this.mapID;\r\n    }\r\n\r\n    checkAspect() {\r\n        if (!this.mapID) throw('This instance is already released.');\r\n    }\r\n\r\n    async stats() {\r\n        let text;\r\n        this.checkAspect();\r\n        try {\r\n            const res = await fetch(`${BASEURL}stats?mapID=${this.mapID}`);\r\n            text = await res.text();\r\n        } catch(e) {\r\n            throw(e);\r\n        }\r\n        if (typeof text === 'string' && text.match(/^Error: /)) {\r\n            throw(text);\r\n        }\r\n        return JSON.parse(text);\r\n    }\r\n\r\n    async clean() {\r\n        let text;\r\n        this.checkAspect();\r\n        try {\r\n            const res = await fetch(`${BASEURL}clean?mapID=${this.mapID}`);\r\n            text = await res.text();\r\n        } catch(e) {\r\n            throw(e);\r\n        }\r\n        if (text.match(/^Error: /)) {\r\n            throw(text);\r\n        }\r\n    }\r\n\r\n    async fetchAll() {\r\n        let text;\r\n        this.checkAspect();\r\n        try {\r\n            const res = await fetch(`${BASEURL}fetchAll?mapID=${this.mapID}`);\r\n            text = await res.text();\r\n        } catch(e) {\r\n            throw(e);\r\n        }\r\n        if (text.match(/^Error: /)) {\r\n            throw(text);\r\n        }\r\n    }\r\n\r\n    async remove() {\r\n        this.checkAspect();\r\n        await Weiwudi.removeMap(this.mapID);\r\n        this.release();\r\n    }\r\n\r\n    async cancel() {\r\n        let text;\r\n        this.checkAspect();\r\n        try {\r\n            const res = await fetch(`${BASEURL}cancel?mapID=${this.mapID}`);\r\n            text = await res.text();\r\n        } catch(e) {\r\n            throw(e);\r\n        }\r\n        if (text.match(/^Error: /)) {\r\n            throw(text);\r\n        }\r\n    }\r\n}"],"names":["BASEURL","swChecking","swChecked","CustomEvent","event","params","evt","EventTarget","type","callback","stack","i","l","Weiwudi","sw","swOptions","reg","newWorker","waitingWoker","e","res","rej","mapID","options","text","p","key","val","url","attrs"],"mappings":"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"}