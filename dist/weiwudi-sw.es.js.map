{"version":3,"file":"weiwudi-sw.es.js","sources":["../src/weiwudi_gw_logic.ts","../src/weiwudi_gw.ts"],"sourcesContent":["// @ts-nocheck\r\nexport function Weiwudi_Internal(registerRoute) {\r\n  \"use strict\";\r\n  const MERC_MAX = 20037508.342789244;\r\n  const dbCache = {};\r\n  let fetchAllBlocker;\r\n  const extractTemplate = (template, z, x, y) => {\r\n    const result = template.replace('{z}', z)\r\n      .replace('{x}', x)\r\n      .replace('{y}', y)\r\n      .replace('{-y}', Math.pow(2, z) - y - 1);\r\n    return result;\r\n  };\r\n  const b64toBlob = (b64Data, contentType = '', sliceSize = 512) => {\r\n    const byteCharacters = atob(b64Data);\r\n    const byteArrays = [];\r\n\r\n    for (let offset = 0; offset < byteCharacters.length; offset += sliceSize) {\r\n      const slice = byteCharacters.slice(offset, offset + sliceSize);\r\n\r\n      const byteNumbers = new Array(slice.length);\r\n      for (let i = 0; i < slice.length; i++) {\r\n        byteNumbers[i] = slice.charCodeAt(i);\r\n      }\r\n\r\n      const byteArray = new Uint8Array(byteNumbers);\r\n      byteArrays.push(byteArray);\r\n    }\r\n\r\n    const blob = new Blob(byteArrays, { type: contentType });\r\n    return blob;\r\n  };\r\n  const getDB = async (dbname, table, key) => {\r\n    return new Promise((resolve, reject) => {\r\n      try {\r\n        if (dbCache[dbname]) resolve(dbCache[dbname]);\r\n        else {\r\n          const openDB = indexedDB.open(dbname);\r\n          openDB.onupgradeneeded = function (event) {\r\n            const db = event.target.result;\r\n            db.createObjectStore(table, { keyPath: key });\r\n          };\r\n          openDB.onsuccess = function (event) {\r\n            const db = event.target.result;\r\n            dbCache[dbname] = db;\r\n            resolve(db);\r\n          };\r\n          openDB.onerror = function (error) {\r\n            reject(error);\r\n          };\r\n        }\r\n      } catch (e) {\r\n        reject(e);\r\n      }\r\n    });\r\n  };\r\n  const deleteDB = async (dbname) => {\r\n    if (dbCache[dbname]) {\r\n      const db = dbCache[dbname];\r\n      db.close();\r\n      delete dbCache[dbname];\r\n    }\r\n    return new Promise((resolve, reject) => {\r\n      try {\r\n        const deleteReq = indexedDB.deleteDatabase(dbname);\r\n\r\n        deleteReq.onsuccess = async (event) => {\r\n          resolve();\r\n        };\r\n        deleteReq.onerror = function (error) {\r\n          reject(error);\r\n        };\r\n      } catch (e) {\r\n        reject(e);\r\n      }\r\n    });\r\n  };\r\n  const cleanDB = async (db, table) => {\r\n    return new Promise((resolve, reject) => {\r\n      const tx = db.transaction([table], 'readwrite');\r\n      const store = tx.objectStore(table);\r\n      const clearReq = store.clear();\r\n      clearReq.onsuccess = function (e) {\r\n      };\r\n      clearReq.onerror = function (e) {\r\n        reject(e);\r\n      };\r\n      tx.oncomplete = function (e) {\r\n        resolve();\r\n      };\r\n      tx.onabort = function (e) {\r\n        reject(e);\r\n      };\r\n      tx.onerror = function (e) {\r\n        reject(e);\r\n      };\r\n    });\r\n  };\r\n  const countDB = async (db, table) => {\r\n    return new Promise((resolve, reject) => {\r\n      const tx = db.transaction([table], 'readonly');\r\n      const store = tx.objectStore(table);\r\n      const cursorReq = store.openCursor();\r\n      let count = 0;\r\n      let size = 0;\r\n      cursorReq.onsuccess = function (e) {\r\n        const cursor = cursorReq.result;\r\n        if (cursor) {\r\n          count++;\r\n          size = size + cursor.value.blob.size;\r\n          cursor.continue();\r\n        }\r\n      };\r\n      cursorReq.onerror = function (e) {\r\n        reject(e);\r\n      };\r\n      tx.oncomplete = function (e) {\r\n        resolve({\r\n          count: count,\r\n          size: size\r\n        });\r\n      };\r\n      tx.onabort = function (e) {\r\n        reject(e);\r\n      };\r\n      tx.onerror = function (e) {\r\n        reject(e);\r\n      };\r\n    });\r\n  };\r\n  const getItem = async (db, table, key, dry) => {\r\n    return new Promise((resolve, reject) => {\r\n      const tx = db.transaction([table], 'readonly');\r\n      const store = tx.objectStore(table);\r\n      const getReq = dry ? store.getKey(key) : store.get(key);\r\n      getReq.onsuccess = function (e) {\r\n      };\r\n      getReq.onerror = function (e) {\r\n        reject(e);\r\n      };\r\n      tx.oncomplete = function (e) {\r\n        resolve(getReq.result);\r\n      };\r\n      tx.onabort = function (e) {\r\n        reject(e);\r\n      };\r\n      tx.onerror = function (e) {\r\n        reject(e);\r\n      };\r\n    });\r\n  };\r\n  const putItem = async (db, table, item) => {\r\n    return new Promise((resolve, reject) => {\r\n      const tx = db.transaction([table], 'readwrite');\r\n      const store = tx.objectStore(table);\r\n      const putReq = store.put(item);\r\n      putReq.onsuccess = function (e) {\r\n      };\r\n      putReq.onerror = function (e) {\r\n        reject(e);\r\n      };\r\n      tx.oncomplete = function (e) {\r\n        resolve();\r\n      };\r\n      tx.onabort = function (e) {\r\n        reject(e);\r\n      };\r\n      tx.onerror = function (e) {\r\n        reject(e);\r\n      };\r\n    });\r\n  };\r\n  const deleteItem = async (db, table, key) => {\r\n    return new Promise((resolve, reject) => {\r\n      const tx = db.transaction([table], 'readwrite');\r\n      const store = tx.objectStore(table);\r\n      const delReq = store.delete(key);\r\n      delReq.onsuccess = function (e) {\r\n      };\r\n      delReq.onerror = function (e) {\r\n        reject(e);\r\n      };\r\n      tx.oncomplete = function (e) {\r\n        resolve();\r\n      };\r\n      tx.onabort = function (e) {\r\n        reject(e);\r\n      };\r\n      tx.onerror = function (e) {\r\n        reject(e);\r\n      };\r\n    });\r\n  };\r\n  const getAllKeys = async (db, table) => {\r\n    return new Promise((resolve, reject) => {\r\n      const tx = db.transaction([table], 'readwrite');\r\n      const store = tx.objectStore(table);\r\n      const getReq = store.getAllKeys();\r\n      getReq.onsuccess = function (e) {\r\n      };\r\n      getReq.onerror = function (e) {\r\n        reject(e);\r\n      };\r\n      tx.oncomplete = function (e) {\r\n        resolve(getReq.result);\r\n      };\r\n      tx.onabort = function (e) {\r\n        reject(e);\r\n      };\r\n      tx.onerror = function (e) {\r\n        reject(e);\r\n      };\r\n    });\r\n  };\r\n  const handlerCb = async ({ url, request, event, _params }) => {\r\n    const client = event.clientId ? await self.clients.get(event.clientId) : undefined;\r\n    const matched = url.pathname.match(/^\\/api\\/([\\w\\d]+)(?:\\/(.+))?$/);\r\n    if (matched) {\r\n      const query = [...url.searchParams.entries()].reduce((obj, e) => {\r\n        const values = url.searchParams.getAll(e[0]);\r\n        if (values.length === 1) obj[e[0]] = values[0];\r\n        else obj[e[0]] = values;\r\n        return obj;\r\n      }, {});\r\n      const apiName = matched[1];\r\n      const restPath = matched[2];\r\n      let res = await apiFunc(apiName, query, restPath, client);\r\n      if (res) {\r\n        if (!(res instanceof Response)) res = new Response(res);\r\n        return res;\r\n      }\r\n    }\r\n  };\r\n  const getImage = async (mapID, z, x, y, noOutput) => {\r\n    let outExtent;\r\n    const db = await getDB('Weiwudi');\r\n    const setting = await getItem(db, 'mapSetting', mapID);\r\n    if (!noOutput) {\r\n      if (!setting) return `Error: MapID \"${mapID}\" not found`;\r\n      if (z < setting.minZoom || z > setting.maxZoom) outExtent = 'zoom';\r\n      else {\r\n        const minXatZ = Math.floor(setting.minX / Math.pow(2, setting.maxZoom - z));\r\n        const maxXatZ = Math.floor(setting.maxX / Math.pow(2, setting.maxZoom - z));\r\n        const minYatZ = Math.floor(setting.minY / Math.pow(2, setting.maxZoom - z));\r\n        const maxYatZ = Math.floor(setting.maxY / Math.pow(2, setting.maxZoom - z));\r\n        if (x < minXatZ || x > maxXatZ || y < minYatZ || y > maxYatZ) outExtent = 'extent';\r\n      }\r\n    }\r\n    let headers = {};\r\n    let blob;\r\n    let status = 200;\r\n    let statusText = 'OK';\r\n    if (outExtent) {\r\n      if (outExtent === 'zoom') {\r\n        status = 404;\r\n        statusText = 'Not Found';\r\n      } else {\r\n        headers = {\r\n          'content-type': 'image/png'\r\n        };\r\n        blob = b64toBlob('iVBORw0KGgoAAAANSUhEUgAAAQAAAAEACAMAAABrrFhUAAAAB3RJTUUH3QgIBToaSbAjlwAAABd0' +\r\n          'RVh0U29mdHdhcmUAR0xEUE5HIHZlciAzLjRxhaThAAAACHRwTkdHTEQzAAAAAEqAKR8AAAAEZ0FN' +\r\n          'QQAAsY8L/GEFAAAAA1BMVEX///+nxBvIAAAAAXRSTlMAQObYZgAAAFRJREFUeNrtwQEBAAAAgJD+' +\r\n          'r+4ICgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA' +\r\n          'AAAAAAAAAAAAABgBDwABHHIJwwAAAABJRU5ErkJggg==', headers['content-type']);\r\n      }\r\n    } else {\r\n      const cacheDB = await getDB(`Weiwudi_${mapID}`);\r\n      const cached = await getItem(cacheDB, 'tileCache', `${z}_${x}_${y}`, noOutput);\r\n      const nowEpoch = new Date().getTime();\r\n      if (!cached || !cached.epoch || nowEpoch - cached.epoch > 86400000) {\r\n        const template = setting.url instanceof Array ?\r\n          setting.url[Math.floor(Math.random() * setting.url.length)] :\r\n          setting.url;\r\n        const url = extractTemplate(template, z, x, y);\r\n        try {\r\n          const resp = await fetch(url);\r\n          if (resp.ok) {\r\n            headers = [...resp.headers.entries()].reduce((obj, e) => ({ ...obj, [e[0]]: e[1] }), {});\r\n            blob = await resp.blob();\r\n            await putItem(cacheDB, 'tileCache', {\r\n              'z_x_y': `${z}_${x}_${y}`,\r\n              headers: headers,\r\n              blob: blob,\r\n              epoch: nowEpoch\r\n            });\r\n          } else {\r\n            if (cached) {\r\n              headers = cached.headers;\r\n              blob = cached.blob;\r\n            } else {\r\n              status = resp.status;\r\n              statusText = resp.statusText;\r\n              headers = [...resp.headers.entries()].reduce((obj, e) => ({ ...obj, [e[0]]: e[1] }), {});\r\n              blob = await resp.blob();\r\n            }\r\n            if (fetchAllBlocker) fetchAllBlocker.error++;\r\n          }\r\n        } catch (e) {\r\n          if (cached) {\r\n            headers = cached.headers;\r\n            blob = cached.blob;\r\n          } else {\r\n            status = 404;\r\n            statusText = 'Not Found';\r\n          }\r\n          if (fetchAllBlocker) fetchAllBlocker.error++;\r\n        }\r\n      } else if (!noOutput) {\r\n        headers = cached.headers;\r\n        blob = cached.blob;\r\n      }\r\n    }\r\n    return noOutput ? undefined : new Response(blob, {\r\n      status,\r\n      statusText,\r\n      headers: new Headers(headers)\r\n    });\r\n  };\r\n  const fetchAll = async (client, setting) => {\r\n    let processed = 0;\r\n    let error = 0;\r\n    let percent = 0;\r\n    const db = await getDB(`Weiwudi_${setting.mapID}`);\r\n    const allKeys = await getAllKeys(db, 'tileCache');\r\n    try {\r\n      const allTasks = [];\r\n      for (let z = setting.minZoom; z <= setting.maxZoom; z++) {\r\n        const maxXatZ = Math.floor(setting.maxX / Math.pow(2, setting.maxZoom - z));\r\n        const minXatZ = Math.floor(setting.minX / Math.pow(2, setting.maxZoom - z));\r\n        const maxYatZ = Math.floor(setting.maxY / Math.pow(2, setting.maxZoom - z));\r\n        const minYatZ = Math.floor(setting.minY / Math.pow(2, setting.maxZoom - z));\r\n        for (let x = minXatZ; x <= maxXatZ; x++) {\r\n          for (let y = minYatZ; y <= maxYatZ; y++) {\r\n            allTasks.push([z, x, y]);\r\n          }\r\n        }\r\n      }\r\n      if (allTasks.length != setting.totalTile) console.log('Number of tiles is different');\r\n      let subTasks = allTasks.splice(0, 5);\r\n      while (subTasks.length) {\r\n        //Alive check\r\n        const checkClient = await self.clients.get(client.id);\r\n        if (!checkClient) {\r\n          fetchAllBlocker = undefined;\r\n          return;\r\n        }\r\n        if (fetchAllBlocker.cancel) {\r\n          fetchAllBlocker = undefined;\r\n          client.postMessage({\r\n            type: 'canceled',\r\n            message: `Fetching tile of ${setting.mapID} is canceled`,\r\n            mapID: setting.mapID\r\n          });\r\n          return;\r\n        }\r\n        const promises = subTasks.map((task) => {\r\n          if (allKeys.indexOf(`${task[0]}_${task[1]}_${task[2]}`) >= 0) return;\r\n          return getImage(setting.mapID, task[0], task[1], task[2], true);\r\n        });\r\n        await Promise.all(promises);\r\n        processed += promises.length;\r\n        fetchAllBlocker.count = processed;\r\n        percent = Math.floor(processed * 100 / setting.totalTile);\r\n        client.postMessage({\r\n          type: 'proceed',\r\n          message: `Proceeding the tile fetching: ${setting.mapID} ${percent}% (${processed} / ${setting.totalTile})`,\r\n          percent,\r\n          processed,\r\n          error: fetchAllBlocker.error,\r\n          total: setting.totalTile,\r\n          mapID: setting.mapID\r\n        });\r\n        subTasks = allTasks.splice(0, 5);\r\n      }\r\n      const error = fetchAllBlocker.error;\r\n      fetchAllBlocker = undefined;\r\n      client.postMessage({\r\n        type: 'finish',\r\n        message: `Fetched all tiles of ${setting.mapID}${error ? ` with ${error} error cases` : ''}`,\r\n        total: setting.totalTile,\r\n        mapID: setting.mapID,\r\n        error\r\n      });\r\n    } catch (e) {\r\n      fetchAllBlocker = undefined;\r\n      client.postMessage({\r\n        type: 'stop',\r\n        message: `Fetching stopped: ${setting.mapID} ${processed} / ${setting.totalTile}`,\r\n        reason: e,\r\n        processed,\r\n        total: setting.totalTile,\r\n        mapID: setting.mapID\r\n      });\r\n    }\r\n  }\r\n  const apiFunc = async (apiName, query, restPath, client) => {\r\n    let retVal;\r\n    const checkAttributes = (query, targets) => {\r\n      return targets.reduce((prev, target) => {\r\n        if (prev) return prev;\r\n        if (query[target] === undefined) return `Error: Attribute \"${target}\" is missing`;\r\n        return prev;\r\n      }, undefined);\r\n    };\r\n    try {\r\n      switch (apiName) {\r\n        case 'ping':\r\n          retVal = 'Implemented';\r\n          break;\r\n        case 'info':\r\n          retVal = checkAttributes(query, ['mapID']);\r\n          if (!retVal) {\r\n            const db = await getDB('Weiwudi', 'mapSetting', 'mapID');\r\n            const setting = await getItem(db, 'mapSetting', query.mapID);\r\n            if (!setting) retVal = `Error: MapID \"${query.mapID}\" not found`;\r\n            else {\r\n              retVal = new Response(JSON.stringify(setting), {\r\n                headers: new Headers({\r\n                  'content-type': 'application/json'\r\n                })\r\n              });\r\n            }\r\n          }\r\n          break;\r\n        case 'add': {\r\n          const db = await getDB('Weiwudi', 'mapSetting', 'mapID');\r\n          retVal = checkAttributes(query, ['mapID', 'type', 'url']);\r\n          if (!retVal) {\r\n            query.tileSize = parseInt(query.tileSize || 256);\r\n            switch (query.type) {\r\n              case 'xyz':\r\n                retVal = checkAttributes(query, ['width', 'height']);\r\n                if (!retVal) {\r\n                  query.width = parseInt(query.width);\r\n                  query.height = parseInt(query.height);\r\n                  const calcZoom = (v) => { return Math.ceil(Math.log(v / query.tileSize) / Math.log(2)) };\r\n                  query.maxZoom = Math.max(calcZoom(query.width), calcZoom(query.height));\r\n                  query.minZoom = query.minZoom ? parseInt(query.minZoom) : 0;\r\n                  query.minX = 0;\r\n                  query.minY = 0;\r\n                  query.maxX = Math.ceil(query.width / query.tileSize) - 1;\r\n                  query.maxY = Math.ceil(query.height / query.tileSize) - 1;\r\n                }\r\n                break;\r\n              case 'wmts':\r\n                if (!retVal) {\r\n                  const lng2MercX = (lng) => { return 6378137 * lng * Math.PI / 180 };\r\n                  const lat2MercY = (lat) => { return 6378137 * Math.log(Math.tan(Math.PI / 360 * (90 + lat))) };\r\n                  if (query.maxZoom) query.maxZoom = parseInt(query.maxZoom);\r\n                  if (query.minZoom) query.minZoom = parseInt(query.minZoom);\r\n                  if (query.maxLng && query.minLng && query.maxLat && query.minLat) {\r\n                    query.maxLng = parseFloat(query.maxLng);\r\n                    query.minLng = parseFloat(query.minLng);\r\n                    query.maxLat = parseFloat(query.maxLat);\r\n                    query.minLat = parseFloat(query.minLat);\r\n                    const maxMercX = lng2MercX(query.maxLng);\r\n                    const minMercX = lng2MercX(query.minLng);\r\n                    const maxMercY = lat2MercY(query.maxLat);\r\n                    const minMercY = lat2MercY(query.minLat);\r\n                    query.minX = Math.floor((MERC_MAX + minMercX) / (2 * MERC_MAX) * Math.pow(2, query.maxZoom));\r\n                    query.maxX = Math.floor((MERC_MAX + maxMercX) / (2 * MERC_MAX) * Math.pow(2, query.maxZoom));\r\n                    query.minY = Math.floor((MERC_MAX - maxMercY) / (2 * MERC_MAX) * Math.pow(2, query.maxZoom));\r\n                    query.maxY = Math.floor((MERC_MAX - minMercY) / (2 * MERC_MAX) * Math.pow(2, query.maxZoom));\r\n                  }\r\n                }\r\n                break;\r\n              default:\r\n                retVal = 'Error: Unknown \"type\" value';\r\n            }\r\n          }\r\n          if (!retVal) {\r\n            if (!checkAttributes(query, ['maxX', 'minX', 'maxY', 'minY', 'minZoom', 'maxZoom'])) {\r\n              query.totalTile = 0;\r\n              const calcTileCoord = (atMaxZoom, zoom) => { return Math.floor(atMaxZoom / Math.pow(2, query.maxZoom - zoom)) };\r\n              for (let z = query.minZoom; z <= query.maxZoom; z++) {\r\n                const minX = calcTileCoord(query.minX, z);\r\n                const minY = calcTileCoord(query.minY, z);\r\n                const maxX = calcTileCoord(query.maxX, z);\r\n                const maxY = calcTileCoord(query.maxY, z);\r\n                query.totalTile += (maxX - minX + 1) * (maxY - minY + 1);\r\n              }\r\n            }\r\n            await putItem(db, 'mapSetting', query);\r\n            await getDB(`Weiwudi_${query.mapID}`, 'tileCache', 'z_x_y');\r\n            retVal = new Response(JSON.stringify(query), {\r\n              headers: new Headers({\r\n                'content-type': 'application/json'\r\n              })\r\n            });\r\n          }\r\n          break;\r\n        }\r\n        case 'clean':\r\n          retVal = checkAttributes(query, ['mapID']);\r\n          if (fetchAllBlocker && fetchAllBlocker.mapID == query.mapID) {\r\n            retVal = `Error: ${query.mapID} is under fetching process. Please cancel it first`;\r\n          } else if (!retVal) {\r\n            const cacheDB = await getDB(`Weiwudi_${query.mapID}`);\r\n            await cleanDB(cacheDB, 'tileCache');\r\n            retVal = `Cleaned: ${query.mapID}`;\r\n          }\r\n          break;\r\n        case 'delete':\r\n          retVal = checkAttributes(query, ['mapID']);\r\n          if (fetchAllBlocker && fetchAllBlocker.mapID == query.mapID) {\r\n            retVal = `Error: ${query.mapID} is under fetching process. Please cancel it first`;\r\n          } else if (!retVal) {\r\n            await deleteDB(`Weiwudi_${query.mapID}`);\r\n            const db = await getDB('Weiwudi');\r\n            await deleteItem(db, 'mapSetting', query.mapID);\r\n            retVal = `Deleted: ${query.mapID}`;\r\n          }\r\n          break;\r\n        case 'cancel':\r\n          retVal = checkAttributes(query, ['mapID']);\r\n          if (fetchAllBlocker && fetchAllBlocker.mapID == query.mapID) {\r\n            fetchAllBlocker.cancel = true;\r\n            retVal = `Fetching process of ${fetchAllBlocker.mapID} is canceled`;\r\n          } else {\r\n            retVal = `Error: There are no fetching process of ${query.mapID}`;\r\n          }\r\n          break;\r\n        case 'stats':\r\n          retVal = checkAttributes(query, ['mapID']);\r\n          if (!retVal) {\r\n            const db = await getDB('Weiwudi');\r\n            const setting = await getItem(db, 'mapSetting', query.mapID);\r\n            if (!setting) retVal = `Error: MapID \"${query.mapID}\" not found`;\r\n            else {\r\n              const cacheDB = await getDB(`Weiwudi_${query.mapID}`);\r\n              const ret = await countDB(cacheDB, 'tileCache');\r\n              if (setting.totalTile) {\r\n                ret.total = setting.totalTile;\r\n                ret.percent = Math.floor(ret.count / ret.total * 100);\r\n              }\r\n              retVal = new Response(JSON.stringify(ret), {\r\n                headers: new Headers({\r\n                  'content-type': 'application/json'\r\n                })\r\n              });\r\n            }\r\n          }\r\n          break;\r\n        case 'cache': {\r\n          const matched = restPath.match(/^([^/]+)\\/(\\d+)\\/(\\d+)\\/(\\d+)$/);\r\n          if (matched) {\r\n            retVal = await getImage(matched[1], parseInt(matched[2]), parseInt(matched[3]), parseInt(matched[4]));\r\n          } else {\r\n            retVal = 'Error: \"cache\" api needs mapID, zoom, x, y settings';\r\n          }\r\n          break;\r\n        }\r\n        case 'fetchAll':\r\n          retVal = checkAttributes(query, ['mapID']);\r\n          if (!retVal) {\r\n            const db = await getDB('Weiwudi');\r\n            const setting = await getItem(db, 'mapSetting', query.mapID);\r\n            if (!setting) retVal = `Error: MapID \"${query.mapID}\" not found`;\r\n            else if (!setting.totalTile) retVal = `Error: Map \"${query.mapID}\" cannot fetch all tiles`;\r\n            else if (fetchAllBlocker) {\r\n              retVal = `Error: Another fetching process is running: \"${fetchAllBlocker.mapID}\" (${fetchAllBlocker.count} / ${fetchAllBlocker.total})`;\r\n            } else {\r\n              setTimeout(() => {\r\n                fetchAllBlocker = {\r\n                  mapID: query.mapID,\r\n                  total: setting.totalTile,\r\n                  count: 0,\r\n                  error: 0\r\n                };\r\n                fetchAll(client, setting);\r\n              }, 1);\r\n              retVal = `Fetching task start: ${query.mapID}`;\r\n            }\r\n          }\r\n          break;\r\n        default:\r\n          retVal = `Error: API ${apiName} not found`;\r\n      }\r\n    } catch (e) {\r\n      retVal = `Error: ${e}`;\r\n    }\r\n\r\n    if (retVal) return retVal;\r\n  };\r\n\r\n  registerRoute(/^https?:\\/\\/weiwudi.example.com/, handlerCb, 'GET');\r\n}","import {registerRoute} from \"workbox-routing\";\r\nimport {Weiwudi_Internal} from \"./weiwudi_gw_logic\";\r\n\r\nWeiwudi_Internal(registerRoute);"],"names":["Weiwudi_Internal","registerRoute","MERC_MAX","dbCache","fetchAllBlocker","extractTemplate","template","z","x","y","b64toBlob","b64Data","contentType","sliceSize","byteCharacters","byteArrays","offset","slice","byteNumbers","i","byteArray","getDB","dbname","table","key","resolve","reject","openDB","event","db","error","e","deleteDB","deleteReq","cleanDB","tx","clearReq","countDB","cursorReq","count","size","cursor","getItem","dry","store","getReq","putItem","item","putReq","deleteItem","delReq","getAllKeys","handlerCb","url","request","_params","client","matched","query","obj","values","apiName","restPath","res","apiFunc","getImage","mapID","noOutput","outExtent","setting","minXatZ","maxXatZ","minYatZ","maxYatZ","headers","blob","status","statusText","cacheDB","cached","nowEpoch","resp","fetchAll","processed","percent","allKeys","allTasks","subTasks","promises","task","retVal","checkAttributes","targets","prev","target","calcZoom","v","lng2MercX","lng","lat2MercY","lat","maxMercX","minMercX","maxMercY","minMercY","calcTileCoord","atMaxZoom","zoom","minX","minY","maxX","maxY","ret"],"mappings":"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"}