(function(i,c){typeof exports=="object"&&typeof module<"u"?module.exports=c():typeof define=="function"&&define.amd?define(c):(i=typeof globalThis<"u"?globalThis:i||self,i.Weiwudi=c())})(this,(function(){"use strict";const i="https://weiwudi.example.com/api/";let c,o;(function(){if(typeof window.CustomEvent=="function")return!1;function l(e,t){t=t||{bubbles:!1,cancelable:!1,detail:void 0};var r=document.createEvent("CustomEvent");return r.initCustomEvent(e,t.bubbles,t.cancelable,t.detail),r}l.prototype=window.Event.prototype,window.CustomEvent=l})();class d{constructor(){this.listeners={}}addEventListener(e,t){e in this.listeners||(this.listeners[e]=[]),this.listeners[e].push(t)}removeEventListener(e,t){if(!(e in this.listeners))return;const r=this.listeners[e];for(let s=0,n=r.length;s<n;s++)if(r[s]===t){r.splice(s,1);return}}dispatchEvent(e){if(!(e.type in this.listeners))return!0;const t=this.listeners[e.type].slice();for(let r=0,s=t.length;r<s;r++)t[r].call(this,e);return!e.defaultPrevented}}class a extends d{static async registerSW(e,t){if("serviceWorker"in navigator)try{const r=await navigator.serviceWorker.register(e,t),s=r.installing,n=r.waiting;return s&&(s.state==="activated"&&!n&&window.location.reload(),s.addEventListener("statechange",w=>{s.state==="activated"&&!n&&window.location.reload()})),r.onupdatefound=()=>{r.update()},await a.swCheck(),r}catch(r){throw`Error: Service worker registration failed with ${r}`}else throw"Error: Service worker is not supported"}static async swCheck(){return o!==void 0?o:(c===void 0&&(c=new Promise(async(e,t)=>{try{o=await fetch(`${i}ping`),o=!!o}catch{o=!1}e(o)})),c)}static async registerMap(e,t){if(!await a.swCheck())throw"Weiwudi service worker is not implemented.";let s;try{const n=["type","url","width","height","tileSize","minZoom","maxZoom","maxLng","maxLat","minLng","minLat"].reduce((f,h)=>(typeof t[h]<"u"&&(t[h]instanceof Array?t[h].map(p=>{f.append(h,p)}):f.append(h,t[h])),f),new URLSearchParams);n.append("mapID",e);const w=new URL(`${i}add`);w.search=n,s=await(await fetch(w.href)).text()}catch(n){throw n}if(s.match(/^Error: /))throw s;return new a(e,JSON.parse(s))}static async retrieveMap(e){if(!await a.swCheck())throw"Weiwudi service worker is not implemented.";let r;try{r=await(await fetch(`${i}info?mapID=${e}`)).text()}catch(s){throw s}if(r.match(/^Error: /))throw r;return console.log(r),new a(e,JSON.parse(r))}static async removeMap(e){if(!await a.swCheck())throw"Weiwudi service worker is not implemented.";let r;try{r=await(await fetch(`${i}delete?mapID=${e}`)).text()}catch(s){throw s}if(r.match(/^Error: /))throw r}constructor(e,t){if(super(),!e)throw"MapID is necessary.";this.mapID=e,t&&Object.assign(this,t),this.url=`${i}cache/${e}/{z}/{x}/{y}`,this.listener=r=>{r.data.mapID===e&&this.dispatchEvent(new CustomEvent(r.data.type,{detail:r.data}))},navigator.serviceWorker.addEventListener("message",this.listener)}release(){navigator.serviceWorker.removeEventListener("message",this.listener),delete this.mapID}checkAspect(){if(!this.mapID)throw"This instance is already released."}async stats(){let e;this.checkAspect();try{e=await(await fetch(`${i}stats?mapID=${this.mapID}`)).text()}catch(t){throw t}if(typeof e=="string"&&e.match(/^Error: /))throw e;return JSON.parse(e)}async clean(){let e;this.checkAspect();try{e=await(await fetch(`${i}clean?mapID=${this.mapID}`)).text()}catch(t){throw t}if(e.match(/^Error: /))throw e}async fetchAll(){let e;this.checkAspect();try{e=await(await fetch(`${i}fetchAll?mapID=${this.mapID}`)).text()}catch(t){throw t}if(e.match(/^Error: /))throw e}async remove(){this.checkAspect(),await a.removeMap(this.mapID),this.release()}async cancel(){let e;this.checkAspect();try{e=await(await fetch(`${i}cancel?mapID=${this.mapID}`)).text()}catch(t){throw t}if(e.match(/^Error: /))throw e}}return a}));
//# sourceMappingURL=weiwudi.umd.js.map
