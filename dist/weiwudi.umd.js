(function(r,a){typeof exports=="object"&&typeof module<"u"?module.exports=a():typeof define=="function"&&define.amd?define(a):(r=typeof globalThis<"u"?globalThis:r||self,r.Weiwudi=a())})(this,(function(){"use strict";const r="https://weiwudi.example.com/api/";let a,o;(function(){if(typeof window.CustomEvent=="function")return!1;function l(e,s){s=s||{bubbles:!1,cancelable:!1,detail:void 0};var t=document.createEvent("CustomEvent");return t.initCustomEvent(e,s.bubbles,s.cancelable,s.detail),t}l.prototype=window.Event.prototype,window.CustomEvent=l})();class d{constructor(){this.listeners={}}addEventListener(e,s){e in this.listeners||(this.listeners[e]=[]),this.listeners[e].push(s)}removeEventListener(e,s){if(!(e in this.listeners))return;const t=this.listeners[e];for(let i=0,c=t.length;i<c;i++)if(t[i]===s){t.splice(i,1);return}}dispatchEvent(e){if(!(e.type in this.listeners))return!0;const s=this.listeners[e.type].slice();for(let t=0,i=s.length;t<i;t++)s[t].call(this,e);return!e.defaultPrevented}}class n extends d{static async registerSW(e,s){if("serviceWorker"in navigator)try{const t=await navigator.serviceWorker.register(e,s),i=t.installing,c=t.waiting;return i&&(i.state==="activated"&&!c&&window.location.reload(),i.addEventListener("statechange",w=>{i.state==="activated"&&!c&&window.location.reload()})),t.onupdatefound=()=>{t.update()},await n.swCheck(),t}catch(t){throw`Error: Service worker registration failed with ${t}`}else throw"Error: Service worker is not supported"}static async swCheck(){return o!==void 0?o:(a===void 0&&(a=new Promise((e,s)=>{fetch(`${r}ping`).then(t=>{o=!!t,e(o)}).catch(t=>{o=!1,e(o)})})),a)}static async registerMap(e,s){if(!await n.swCheck())throw"Weiwudi service worker is not implemented.";let i;const c=["type","url","width","height","tileSize","minZoom","maxZoom","maxLng","maxLat","minLng","minLat"].reduce((f,h)=>(typeof s[h]<"u"&&(s[h]instanceof Array?s[h].map(p=>{f.append(h,p)}):f.append(h,s[h])),f),new URLSearchParams);c.append("mapID",e);const w=new URL(`${r}add`);if(w.search=c,i=await(await fetch(w.href)).text(),i.match(/^Error: /))throw i;return new n(e,JSON.parse(i))}static async retrieveMap(e){if(!await n.swCheck())throw"Weiwudi service worker is not implemented.";let t;if(t=await(await fetch(`${r}info?mapID=${e}`)).text(),t.match(/^Error: /))throw t;return console.log(t),new n(e,JSON.parse(t))}static async removeMap(e){if(!await n.swCheck())throw"Weiwudi service worker is not implemented.";let t;if(t=await(await fetch(`${r}delete?mapID=${e}`)).text(),t.match(/^Error: /))throw t}constructor(e,s){if(super(),!e)throw"MapID is necessary.";this.mapID=e,s&&Object.assign(this,s),this.url=`${r}cache/${e}/{z}/{x}/{y}`,this.listener=t=>{t.data.mapID===e&&this.dispatchEvent(new CustomEvent(t.data.type,{detail:t.data}))},navigator.serviceWorker.addEventListener("message",this.listener)}release(){navigator.serviceWorker.removeEventListener("message",this.listener),delete this.mapID}checkAspect(){if(!this.mapID)throw"This instance is already released."}async stats(){let e;if(this.checkAspect(),e=await(await fetch(`${r}stats?mapID=${this.mapID}`)).text(),typeof e=="string"&&e.match(/^Error: /))throw e;return JSON.parse(e)}async clean(){let e;if(this.checkAspect(),e=await(await fetch(`${r}clean?mapID=${this.mapID}`)).text(),e.match(/^Error: /))throw e}async fetchAll(){let e;if(this.checkAspect(),e=await(await fetch(`${r}fetchAll?mapID=${this.mapID}`)).text(),e.match(/^Error: /))throw e}async remove(){this.checkAspect(),await n.removeMap(this.mapID),this.release()}async cancel(){let e;if(this.checkAspect(),e=await(await fetch(`${r}cancel?mapID=${this.mapID}`)).text(),e.match(/^Error: /))throw e}}return n}));
//# sourceMappingURL=weiwudi.umd.js.map
