{"version":3,"file":"weiwudi.es.js","sources":["../src/weiwudi.js"],"sourcesContent":["\"use strict\";\r\n\r\nconst BASEURL = 'https://weiwudi.example.com/api/';\r\nlet swChecking;\r\nlet swChecked;\r\n\r\n(function () {\r\n    if (typeof window.CustomEvent === 'function') return false;\r\n\r\n    function CustomEvent(event, params) {\r\n        params = params || { bubbles: false, cancelable: false, detail: undefined };\r\n        var evt = document.createEvent('CustomEvent');\r\n        evt.initCustomEvent(event, params.bubbles, params.cancelable, params.detail);\r\n        return evt;\r\n    }\r\n\r\n    CustomEvent.prototype = window.Event.prototype;\r\n\r\n    window.CustomEvent = CustomEvent;\r\n})();\r\n\r\nclass EventTarget {\r\n    constructor() {\r\n        this.listeners = {};\r\n    }\r\n\r\n    addEventListener(type, callback) {\r\n        if (!(type in this.listeners)) {\r\n            this.listeners[type] = [];\r\n        }\r\n        this.listeners[type].push(callback);\r\n    }\r\n\r\n    removeEventListener(type, callback) {\r\n        if (!(type in this.listeners)) {\r\n            return;\r\n        }\r\n        const stack = this.listeners[type];\r\n        for (let i = 0, l = stack.length; i < l; i++) {\r\n            if (stack[i] === callback){\r\n                stack.splice(i, 1);\r\n                return;\r\n            }\r\n        }\r\n    }\r\n\r\n    dispatchEvent(event) {\r\n        if (!(event.type in this.listeners)) {\r\n            return true;\r\n        }\r\n        const stack = this.listeners[event.type].slice();\r\n\r\n        for (let i = 0, l = stack.length; i < l; i++) {\r\n            stack[i].call(this, event);\r\n        }\r\n        return !event.defaultPrevented;\r\n    }\r\n}\r\n\r\nexport default class Weiwudi extends EventTarget {\r\n    static async registerSW(sw, swOptions) {\r\n        if ('serviceWorker' in navigator) {\r\n            try {\r\n                const reg = await navigator.serviceWorker.register(sw, swOptions);\r\n                //console.log('Service Worker Registered');\r\n\r\n                // A wild service worker has appeared in reg.installing and maybe in waiting!\r\n                const newWorker = reg.installing;\r\n                const waitingWoker = reg.waiting;\r\n\r\n                if (newWorker) {\r\n                    if (newWorker.state === 'activated' && !waitingWoker) {\r\n                        // reload to avoid skipWaiting and clients.claim()\r\n                        window.location.reload();\r\n                    }\r\n                    newWorker.addEventListener('statechange', (e) => {\r\n                        // newWorker.state has changed\r\n                        if (newWorker.state === 'activated' && !waitingWoker) {\r\n                            // reload to avoid skipWaiting and clients.claim()\r\n                            window.location.reload();\r\n                        }\r\n                    });\r\n                }\r\n                reg.onupdatefound = () => {\r\n                    //console.log('Found Service Worker update');\r\n                    reg.update();\r\n                };\r\n\r\n                await Weiwudi.swCheck();\r\n\r\n                return reg;\r\n            } catch(e) {\r\n                throw(`Error: Service worker registration failed with ${e}`);\r\n            }\r\n        } else {\r\n            throw('Error: Service worker is not supported');\r\n        }\r\n    }\r\n\r\n    static async swCheck() {\r\n        if (swChecked !== undefined) return swChecked;\r\n        if (swChecking === undefined) swChecking = new Promise(async (res, rej) => {\r\n            try {\r\n                swChecked = await fetch(`${BASEURL}ping`);\r\n                swChecked = !!swChecked;\r\n            } catch(e) {\r\n                swChecked = false;\r\n            }\r\n            res(swChecked);\r\n        });\r\n        return swChecking;\r\n    }\r\n\r\n    static async registerMap(mapID, options) {\r\n        const swCheck = await Weiwudi.swCheck();\r\n        if (!swCheck) throw('Weiwudi service worker is not implemented.');\r\n        let text;\r\n        try {\r\n            const p = ['type', 'url', 'width', 'height', 'tileSize', 'minZoom', 'maxZoom', 'maxLng', 'maxLat', 'minLng', 'minLat'].reduce((p, key) => {\r\n                if (typeof options[key] !== 'undefined') {\r\n                    if (options[key] instanceof Array) {\r\n                        options[key].map((val) => {\r\n                            p.append(key, val);\r\n                        });\r\n                    } else {\r\n                        p.append(key, options[key]);\r\n                    }\r\n                }\r\n                return p;\r\n            }, new URLSearchParams());\r\n            p.append('mapID', mapID);\r\n            const url = new URL(`${BASEURL}add`);\r\n            url.search = p;\r\n            const res = await fetch(url.href);\r\n            text = await res.text();\r\n        } catch(e) {\r\n            throw(e);\r\n        }\r\n        if (text.match(/^Error: /)) {\r\n            throw(text);\r\n        }\r\n        return new Weiwudi(mapID, JSON.parse(text));\r\n    }\r\n\r\n    static async retrieveMap(mapID) {\r\n        const swCheck = await Weiwudi.swCheck();\r\n        if (!swCheck) throw('Weiwudi service worker is not implemented.');\r\n        let text;\r\n        try {\r\n            const res = await fetch(`${BASEURL}info?mapID=${mapID}`);\r\n            text = await res.text();\r\n        } catch(e) {\r\n            throw(e);\r\n        }\r\n        if (text.match(/^Error: /)) {\r\n            throw(text);\r\n        }\r\n        console.log(text);\r\n        return new Weiwudi(mapID, JSON.parse(text));\r\n    }\r\n\r\n    static async removeMap(mapID) {\r\n        const swCheck = await Weiwudi.swCheck();\r\n        if (!swCheck) throw('Weiwudi service worker is not implemented.');\r\n        let text;\r\n        try {\r\n            const res = await fetch(`${BASEURL}delete?mapID=${mapID}`);\r\n            text = await res.text();\r\n        } catch(e) {\r\n            throw(e);\r\n        }\r\n        if (text.match(/^Error: /)) {\r\n            throw(text);\r\n        }\r\n    }\r\n\r\n    constructor(mapID, attrs) {\r\n        super();\r\n        if (!mapID) throw('MapID is necessary.');\r\n        this.mapID = mapID;\r\n        if (attrs) Object.assign(this, attrs);\r\n        this.url = `${BASEURL}cache/${mapID}/{z}/{x}/{y}`;\r\n        this.listener = (e) => {\r\n            const eventMapID = e.data.mapID;\r\n            if (eventMapID !== mapID) return;\r\n            this.dispatchEvent(new CustomEvent(e.data.type, {detail: e.data}));\r\n        };\r\n        navigator.serviceWorker.addEventListener('message', this.listener);\r\n    }\r\n\r\n    release() {\r\n        navigator.serviceWorker.removeEventListener('message', this.listener);\r\n        delete this.mapID;\r\n    }\r\n\r\n    checkAspect() {\r\n        if (!this.mapID) throw('This instance is already released.');\r\n    }\r\n\r\n    async stats() {\r\n        let text;\r\n        this.checkAspect();\r\n        try {\r\n            const res = await fetch(`${BASEURL}stats?mapID=${this.mapID}`);\r\n            text = await res.text();\r\n        } catch(e) {\r\n            throw(e);\r\n        }\r\n        if (typeof text === 'string' && text.match(/^Error: /)) {\r\n            throw(text);\r\n        }\r\n        return JSON.parse(text);\r\n    }\r\n\r\n    async clean() {\r\n        let text;\r\n        this.checkAspect();\r\n        try {\r\n            const res = await fetch(`${BASEURL}clean?mapID=${this.mapID}`);\r\n            text = await res.text();\r\n        } catch(e) {\r\n            throw(e);\r\n        }\r\n        if (text.match(/^Error: /)) {\r\n            throw(text);\r\n        }\r\n    }\r\n\r\n    async fetchAll() {\r\n        let text;\r\n        this.checkAspect();\r\n        try {\r\n            const res = await fetch(`${BASEURL}fetchAll?mapID=${this.mapID}`);\r\n            text = await res.text();\r\n        } catch(e) {\r\n            throw(e);\r\n        }\r\n        if (text.match(/^Error: /)) {\r\n            throw(text);\r\n        }\r\n    }\r\n\r\n    async remove() {\r\n        this.checkAspect();\r\n        await Weiwudi.removeMap(this.mapID);\r\n        this.release();\r\n    }\r\n\r\n    async cancel() {\r\n        let text;\r\n        this.checkAspect();\r\n        try {\r\n            const res = await fetch(`${BASEURL}cancel?mapID=${this.mapID}`);\r\n            text = await res.text();\r\n        } catch(e) {\r\n            throw(e);\r\n        }\r\n        if (text.match(/^Error: /)) {\r\n            throw(text);\r\n        }\r\n    }\r\n}"],"names":["BASEURL","swChecking","swChecked","CustomEvent","event","params","evt","EventTarget","type","callback","stack","i","l","Weiwudi","sw","swOptions","reg","newWorker","waitingWoker","e","res","rej","mapID","options","text","p","key","val","url","attrs"],"mappings":"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"}