{"version":3,"file":"weiwudi-sw.umd.js","sources":["../src/weiwudi_gw_logic.ts","../src/weiwudi_sw.ts"],"sourcesContent":["/// <reference lib=\"webworker\" />\r\nimport { RouteHandlerCallback } from 'workbox-core';\r\n\r\ninterface MapSetting {\r\n  mapID: string;\r\n  type?: string;\r\n  url?: string | string[];\r\n  minZoom?: number;\r\n  maxZoom?: number;\r\n  minX?: number;\r\n  maxX?: number;\r\n  minY?: number;\r\n  maxY?: number;\r\n  totalTile?: number;\r\n  minLat?: number;\r\n  minLng?: number;\r\n  maxLat?: number;\r\n  maxLng?: number;\r\n  width?: number;\r\n  height?: number;\r\n  tileSize?: number;\r\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n  [key: string]: any;\r\n}\r\n\r\ninterface TileCacheItem {\r\n  z_x_y?: string; // keyPath\r\n  headers: Record<string, string>;\r\n  blob: Blob;\r\n  epoch: number;\r\n}\r\n\r\ninterface FetchAllBlocker {\r\n  mapID: string;\r\n  total: number;\r\n  count: number;\r\n  error: number;\r\n  cancel?: boolean;\r\n}\r\n\r\ninterface DBDict {\r\n  [name: string]: IDBDatabase;\r\n}\r\n\r\ninterface DBCountResult {\r\n  count: number;\r\n  size: number;\r\n  total?: number;\r\n  percent?: number;\r\n}\r\n\r\ndeclare const self: ServiceWorkerGlobalScope;\r\n\r\n// Allow string based method to be compatible with both Workbox types and simple strings\r\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\r\nexport function Weiwudi_Internal(registerRoute: (capture: RegExp, handler: RouteHandlerCallback, method?: any) => any) {\r\n  \"use strict\";\r\n  const MERC_MAX = 20037508.342789244;\r\n  const dbCache: DBDict = {};\r\n  let fetchAllBlocker: FetchAllBlocker | undefined;\r\n\r\n  const extractTemplate = (template: string, z: number, x: number, y: number) => {\r\n    const result = template.replace('{z}', String(z))\r\n      .replace('{x}', String(x))\r\n      .replace('{y}', String(y))\r\n      .replace('{-y}', String(Math.pow(2, z) - y - 1));\r\n    return result;\r\n  };\r\n  const b64toBlob = (b64Data: string, contentType = '', sliceSize = 512) => {\r\n    const byteCharacters = atob(b64Data);\r\n    const byteArrays = [];\r\n\r\n    for (let offset = 0; offset < byteCharacters.length; offset += sliceSize) {\r\n      const slice = byteCharacters.slice(offset, offset + sliceSize);\r\n\r\n      const byteNumbers = new Array(slice.length);\r\n      for (let i = 0; i < slice.length; i++) {\r\n        byteNumbers[i] = slice.charCodeAt(i);\r\n      }\r\n\r\n      const byteArray = new Uint8Array(byteNumbers);\r\n      byteArrays.push(byteArray);\r\n    }\r\n\r\n    const blob = new Blob(byteArrays, { type: contentType });\r\n    return blob;\r\n  };\r\n  const getDB = async (dbname: string, table?: string, key?: string): Promise<IDBDatabase> => {\r\n    return new Promise((resolve, reject) => {\r\n      try {\r\n        if (dbCache[dbname]) resolve(dbCache[dbname]);\r\n        else {\r\n          const openDB = indexedDB.open(dbname);\r\n          openDB.onupgradeneeded = function (event) {\r\n            const db = (event.target as IDBOpenDBRequest).result;\r\n            if (table && key) db.createObjectStore(table, { keyPath: key });\r\n          };\r\n          openDB.onsuccess = function (event) {\r\n            const db = (event.target as IDBOpenDBRequest).result;\r\n            dbCache[dbname] = db;\r\n            resolve(db);\r\n          };\r\n          openDB.onerror = function (_error) {\r\n            reject(openDB.error);\r\n          };\r\n        }\r\n      } catch (e) {\r\n        reject(e);\r\n      }\r\n    });\r\n  };\r\n  const deleteDB = async (dbname: string): Promise<void> => {\r\n    if (dbCache[dbname]) {\r\n      const db = dbCache[dbname];\r\n      db.close();\r\n      delete dbCache[dbname];\r\n    }\r\n    return new Promise((resolve, reject) => {\r\n      try {\r\n        const deleteReq = indexedDB.deleteDatabase(dbname);\r\n\r\n        deleteReq.onsuccess = async (_event) => {\r\n          resolve();\r\n        };\r\n        deleteReq.onerror = function (error) {\r\n          reject(error);\r\n        };\r\n      } catch (e) {\r\n        reject(e);\r\n      }\r\n    });\r\n  };\r\n  const cleanDB = async (db: IDBDatabase, table: string): Promise<void> => {\r\n    return new Promise((resolve, reject) => {\r\n      const tx = db.transaction([table], 'readwrite');\r\n      const store = tx.objectStore(table);\r\n      const clearReq = store.clear();\r\n      clearReq.onsuccess = function (_e) {\r\n      };\r\n      clearReq.onerror = function (e) {\r\n        reject(e);\r\n      };\r\n      tx.oncomplete = function (_e) {\r\n        resolve();\r\n      };\r\n      tx.onabort = function (e) {\r\n        reject(e);\r\n      };\r\n      tx.onerror = function (e) {\r\n        reject(e);\r\n      };\r\n    });\r\n  };\r\n  const countDB = async (db: IDBDatabase, table: string): Promise<DBCountResult> => {\r\n    return new Promise((resolve, reject) => {\r\n      const tx = db.transaction([table], 'readonly');\r\n      const store = tx.objectStore(table);\r\n      const cursorReq = store.openCursor();\r\n      let count = 0;\r\n      let size = 0;\r\n      cursorReq.onsuccess = function (_e) {\r\n        const cursor = cursorReq.result;\r\n        if (cursor) {\r\n          count++;\r\n          size = size + (cursor.value.blob.size as number);\r\n          cursor.continue();\r\n        }\r\n      };\r\n      cursorReq.onerror = function (e) {\r\n        reject(e);\r\n      };\r\n      tx.oncomplete = function (_e) {\r\n        resolve({\r\n          count: count,\r\n          size: size\r\n        });\r\n      };\r\n      tx.onabort = function (e) {\r\n        reject(e);\r\n      };\r\n      tx.onerror = function (e) {\r\n        reject(e);\r\n      };\r\n    });\r\n  };\r\n  const getItem = async (db: IDBDatabase, table: string, key: string, dry?: boolean): Promise<unknown> => {\r\n    return new Promise((resolve, reject) => {\r\n      const tx = db.transaction([table], 'readonly');\r\n      const store = tx.objectStore(table);\r\n      const getReq = dry ? store.getKey(key) : store.get(key);\r\n      getReq.onsuccess = function (_e) {\r\n      };\r\n      getReq.onerror = function (e) {\r\n        reject(e);\r\n      };\r\n      tx.oncomplete = function (_e) {\r\n        resolve(getReq.result);\r\n      };\r\n      tx.onabort = function (e) {\r\n        reject(e);\r\n      };\r\n      tx.onerror = function (e) {\r\n        reject(e);\r\n      };\r\n    });\r\n  };\r\n  const putItem = async (db: IDBDatabase, table: string, item: unknown): Promise<void> => {\r\n    return new Promise((resolve, reject) => {\r\n      const tx = db.transaction([table], 'readwrite');\r\n      const store = tx.objectStore(table);\r\n      const putReq = store.put(item);\r\n      putReq.onsuccess = function (_e) {\r\n      };\r\n      putReq.onerror = function (e) {\r\n        reject(e);\r\n      };\r\n      tx.oncomplete = function (_e) {\r\n        resolve();\r\n      };\r\n      tx.onabort = function (e) {\r\n        reject(e);\r\n      };\r\n      tx.onerror = function (e) {\r\n        reject(e);\r\n      };\r\n    });\r\n  };\r\n  const deleteItem = async (db: IDBDatabase, table: string, key: string): Promise<void> => {\r\n    return new Promise((resolve, reject) => {\r\n      const tx = db.transaction([table], 'readwrite');\r\n      const store = tx.objectStore(table);\r\n      const delReq = store.delete(key);\r\n      delReq.onsuccess = function (_e) {\r\n      };\r\n      delReq.onerror = function (e) {\r\n        reject(e);\r\n      };\r\n      tx.oncomplete = function (_e) {\r\n        resolve();\r\n      };\r\n      tx.onabort = function (e) {\r\n        reject(e);\r\n      };\r\n      tx.onerror = function (e) {\r\n        reject(e);\r\n      };\r\n    });\r\n  };\r\n  const getAllKeys = async (db: IDBDatabase, table: string): Promise<unknown[]> => {\r\n    return new Promise((resolve, reject) => {\r\n      const tx = db.transaction([table], 'readwrite');\r\n      const store = tx.objectStore(table);\r\n      const getReq = store.getAllKeys();\r\n      getReq.onsuccess = function (_e) {\r\n      };\r\n      getReq.onerror = function (e) {\r\n        reject(e);\r\n      };\r\n      tx.oncomplete = function (_e) {\r\n        resolve(getReq.result);\r\n      };\r\n      tx.onabort = function (e) {\r\n        reject(e);\r\n      };\r\n      tx.onerror = function (e) {\r\n        reject(e);\r\n      };\r\n    });\r\n  };\r\n  const handlerCb: RouteHandlerCallback = async ({ url, event }) => {\r\n    const fetchEvent = event instanceof FetchEvent ? event : undefined;\r\n    const client = fetchEvent && fetchEvent.clientId ? await self.clients.get(fetchEvent.clientId) : undefined;\r\n    const matched = url.pathname.match(/^\\/api\\/([\\w\\d]+)(?:\\/(.+))?$/);\r\n    if (matched) {\r\n      // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n      const query = [...url.searchParams.entries()].reduce((obj: any, e) => {\r\n        const values = url.searchParams.getAll(e[0]);\r\n        if (values.length === 1) obj[e[0]] = values[0];\r\n        else obj[e[0]] = values;\r\n        return obj;\r\n      }, {});\r\n      const apiName = matched[1];\r\n      const restPath = matched[2];\r\n      let res = await apiFunc(apiName, query, restPath, client);\r\n      if (res) {\r\n        if (!(res instanceof Response)) res = new Response(res);\r\n        return res;\r\n      }\r\n    }\r\n    return new Response('Not Found', { status: 404 });\r\n  };\r\n  const getImage = async (mapID: string, z: number, x: number, y: number, noOutput?: boolean) => {\r\n    let outExtent;\r\n    const db = await getDB('Weiwudi');\r\n    const setting = await getItem(db, 'mapSetting', mapID) as MapSetting;\r\n    if (!noOutput) {\r\n      if (!setting) return `Error: MapID \"${mapID}\" not found`;\r\n      if (z < (setting.minZoom || 0) || z > (setting.maxZoom || 0)) outExtent = 'zoom';\r\n      else if (setting.minX !== undefined && setting.maxX !== undefined && setting.minY !== undefined && setting.maxY !== undefined) {\r\n        const factor = Math.pow(2, (setting.maxZoom || 0) - z);\r\n        const minXatZ = Math.floor((setting.minX || 0) / factor);\r\n        const maxXatZ = Math.floor((setting.maxX || 0) / factor);\r\n        const minYatZ = Math.floor((setting.minY || 0) / factor);\r\n        const maxYatZ = Math.floor((setting.maxY || 0) / factor);\r\n        if (x < minXatZ || x > maxXatZ || y < minYatZ || y > maxYatZ) outExtent = 'extent';\r\n      }\r\n    }\r\n    let headers: Record<string, string> = {};\r\n    let blob: Blob | undefined;\r\n    let status = 200;\r\n    let statusText = 'OK';\r\n    if (outExtent) {\r\n      if (outExtent === 'zoom') {\r\n        status = 404;\r\n        statusText = 'Not Found';\r\n      } else {\r\n        headers = {\r\n          'content-type': 'image/png'\r\n        };\r\n        blob = b64toBlob('iVBORw0KGgoAAAANSUhEUgAAAQAAAAEACAMAAABrrFhUAAAAB3RJTUUH3QgIBToaSbAjlwAAABd0' +\r\n          'RVh0U29mdHdhcmUAR0xEUE5HIHZlciAzLjRxhaThAAAACHRwTkdHTEQzAAAAAEqAKR8AAAAEZ0FN' +\r\n          'QQAAsY8L/GEFAAAAA1BMVEX///+nxBvIAAAAAXRSTlMAQObYZgAAAFRJREFUeNrtwQEBAAAAgJD+' +\r\n          'r+4ICgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA' +\r\n          'AAAAAAAAAAAAABgBDwABHHIJwwAAAABJRU5ErkJggg==', headers['content-type']);\r\n      }\r\n    } else {\r\n      const cacheDB = await getDB(`Weiwudi_${mapID}`);\r\n      const cached = await getItem(cacheDB, 'tileCache', `${z}_${x}_${y}`, noOutput) as TileCacheItem;\r\n      const nowEpoch = new Date().getTime();\r\n      if (!cached || !cached.epoch || nowEpoch - cached.epoch > 86400000) {\r\n        // Handle setting.url being potentially undefined or array\r\n        let template = '';\r\n        if (setting.url instanceof Array) {\r\n          template = setting.url[Math.floor(Math.random() * setting.url.length)];\r\n        } else if (typeof setting.url === 'string') {\r\n          template = setting.url;\r\n        }\r\n\r\n        const url = extractTemplate(template, z, x, y);\r\n        try {\r\n          const resp = await fetch(url);\r\n          if (resp.ok) {\r\n            headers = {};\r\n            resp.headers.forEach((val, key) => { headers[key] = val; });\r\n            blob = await resp.blob();\r\n            await putItem(cacheDB, 'tileCache', {\r\n              'z_x_y': `${z}_${x}_${y}`,\r\n              headers: headers,\r\n              blob: blob,\r\n              epoch: nowEpoch\r\n            });\r\n          } else {\r\n            if (cached) {\r\n              headers = cached.headers;\r\n              blob = cached.blob;\r\n            } else {\r\n              status = resp.status;\r\n              statusText = resp.statusText;\r\n              headers = {};\r\n              resp.headers.forEach((val, key) => { headers[key] = val; });\r\n              blob = await resp.blob();\r\n            }\r\n            if (fetchAllBlocker) fetchAllBlocker.error++;\r\n          }\r\n        } catch (_e) {\r\n          if (cached) {\r\n            headers = cached.headers;\r\n            blob = cached.blob;\r\n          } else {\r\n            status = 404;\r\n            statusText = 'Not Found';\r\n          }\r\n          if (fetchAllBlocker) fetchAllBlocker.error++;\r\n        }\r\n      } else if (!noOutput) {\r\n        headers = cached.headers;\r\n        blob = cached.blob;\r\n      }\r\n    }\r\n    return noOutput ? undefined : new Response(blob, {\r\n      status,\r\n      statusText,\r\n      headers: new Headers(headers)\r\n    });\r\n  };\r\n  const fetchAll = async (client: Client, setting: MapSetting) => {\r\n    let processed = 0;\r\n    let percent = 0;\r\n    const db = await getDB(`Weiwudi_${setting.mapID}`);\r\n    const allKeys = await getAllKeys(db, 'tileCache');\r\n    try {\r\n      const allTasks = [];\r\n      const minZoom = setting.minZoom || 0;\r\n      const maxZoom = setting.maxZoom || 0;\r\n      for (let z = minZoom; z <= maxZoom; z++) {\r\n        const factor = Math.pow(2, maxZoom - z);\r\n        const maxXatZ = Math.floor((setting.maxX || 0) / factor);\r\n        const minXatZ = Math.floor((setting.minX || 0) / factor);\r\n        const maxYatZ = Math.floor((setting.maxY || 0) / factor);\r\n        const minYatZ = Math.floor((setting.minY || 0) / factor);\r\n        for (let x = minXatZ; x <= maxXatZ; x++) {\r\n          for (let y = minYatZ; y <= maxYatZ; y++) {\r\n            allTasks.push([z, x, y]);\r\n          }\r\n        }\r\n      }\r\n      if (allTasks.length != setting.totalTile) console.log('Number of tiles is different');\r\n      let subTasks = allTasks.splice(0, 5);\r\n      while (subTasks.length) {\r\n        //Alive check\r\n        const checkClient = await self.clients.get(client.id);\r\n        if (!checkClient) {\r\n          fetchAllBlocker = undefined;\r\n          return;\r\n        }\r\n        if (fetchAllBlocker && fetchAllBlocker.cancel) {\r\n          fetchAllBlocker = undefined;\r\n          client.postMessage({\r\n            type: 'canceled',\r\n            message: `Fetching tile of ${setting.mapID} is canceled`,\r\n            mapID: setting.mapID\r\n          });\r\n          return;\r\n        }\r\n        const promises = subTasks.map((task) => {\r\n          if (allKeys.indexOf(`${task[0]}_${task[1]}_${task[2]}`) >= 0) return;\r\n          return getImage(setting.mapID, task[0], task[1], task[2], true);\r\n        });\r\n        await Promise.all(promises);\r\n        processed += promises.length;\r\n        if (fetchAllBlocker) fetchAllBlocker.count = processed;\r\n        percent = Math.floor(processed * 100 / (setting.totalTile || 1));\r\n        client.postMessage({\r\n          type: 'proceed',\r\n          message: `Proceeding the tile fetching: ${setting.mapID} ${percent}% (${processed} / ${setting.totalTile})`,\r\n          percent,\r\n          processed,\r\n          error: fetchAllBlocker ? fetchAllBlocker.error : 0,\r\n          total: setting.totalTile,\r\n          mapID: setting.mapID\r\n        });\r\n        subTasks = allTasks.splice(0, 5);\r\n      }\r\n      const error = fetchAllBlocker ? fetchAllBlocker.error : 0;\r\n      fetchAllBlocker = undefined;\r\n      client.postMessage({\r\n        type: 'finish',\r\n        message: `Fetched all tiles of ${setting.mapID}${error ? ` with ${error} error cases` : ''}`,\r\n        total: setting.totalTile,\r\n        mapID: setting.mapID,\r\n        error\r\n      });\r\n    } catch (e) {\r\n      fetchAllBlocker = undefined;\r\n      client.postMessage({\r\n        type: 'stop',\r\n        message: `Fetching stopped: ${setting.mapID} ${processed} / ${setting.totalTile}`,\r\n        reason: e,\r\n        processed,\r\n        total: setting.totalTile,\r\n        mapID: setting.mapID\r\n      });\r\n    }\r\n  }\r\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n  const apiFunc = async (apiName: string, query: any, restPath: string | undefined, client?: Client) => {\r\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n    let retVal: any;\r\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n    const checkAttributes = (query: any, targets: string[]) => {\r\n      return targets.reduce((prev: string | undefined, target) => {\r\n        if (prev) return prev;\r\n        if (query[target] === undefined) return `Error: Attribute \"${target}\" is missing`;\r\n        return prev;\r\n      }, undefined);\r\n    };\r\n    try {\r\n      switch (apiName) {\r\n        case 'ping':\r\n          retVal = 'Implemented';\r\n          break;\r\n        case 'info':\r\n          retVal = checkAttributes(query, ['mapID']);\r\n          if (!retVal) {\r\n            const db = await getDB('Weiwudi', 'mapSetting', 'mapID');\r\n            const setting = await getItem(db, 'mapSetting', query.mapID);\r\n            if (!setting) retVal = `Error: MapID \"${query.mapID}\" not found`;\r\n            else {\r\n              retVal = new Response(JSON.stringify(setting), {\r\n                headers: new Headers({\r\n                  'content-type': 'application/json'\r\n                })\r\n              });\r\n            }\r\n          }\r\n          break;\r\n        case 'add': {\r\n          const db = await getDB('Weiwudi', 'mapSetting', 'mapID');\r\n          retVal = checkAttributes(query, ['mapID', 'type', 'url']);\r\n          if (!retVal) {\r\n            query.tileSize = parseInt(query.tileSize || 256);\r\n            switch (query.type) {\r\n              case 'xyz':\r\n                retVal = checkAttributes(query, ['width', 'height']);\r\n                if (!retVal) {\r\n                  query.width = parseInt(query.width);\r\n                  query.height = parseInt(query.height);\r\n                  const calcZoom = (v: number) => { return Math.ceil(Math.log(v / query.tileSize) / Math.log(2)) };\r\n                  query.maxZoom = Math.max(calcZoom(query.width), calcZoom(query.height));\r\n                  query.minZoom = query.minZoom ? parseInt(query.minZoom) : 0;\r\n                  query.minX = 0;\r\n                  query.minY = 0;\r\n                  query.maxX = Math.ceil(query.width / query.tileSize) - 1;\r\n                  query.maxY = Math.ceil(query.height / query.tileSize) - 1;\r\n                }\r\n                break;\r\n              case 'wmts':\r\n                if (!retVal) {\r\n                  const lng2MercX = (lng: number) => { return 6378137 * lng * Math.PI / 180 };\r\n                  const lat2MercY = (lat: number) => { return 6378137 * Math.log(Math.tan(Math.PI / 360 * (90 + lat))) };\r\n                  if (query.maxZoom) query.maxZoom = parseInt(query.maxZoom);\r\n                  if (query.minZoom) query.minZoom = parseInt(query.minZoom);\r\n                  if (query.maxLng && query.minLng && query.maxLat && query.minLat) {\r\n                    query.maxLng = parseFloat(query.maxLng);\r\n                    query.minLng = parseFloat(query.minLng);\r\n                    query.maxLat = parseFloat(query.maxLat);\r\n                    query.minLat = parseFloat(query.minLat);\r\n                    const maxMercX = lng2MercX(query.maxLng);\r\n                    const minMercX = lng2MercX(query.minLng);\r\n                    const maxMercY = lat2MercY(query.maxLat);\r\n                    const minMercY = lat2MercY(query.minLat);\r\n                    query.minX = Math.floor((MERC_MAX + minMercX) / (2 * MERC_MAX) * Math.pow(2, query.maxZoom));\r\n                    query.maxX = Math.floor((MERC_MAX + maxMercX) / (2 * MERC_MAX) * Math.pow(2, query.maxZoom));\r\n                    query.minY = Math.floor((MERC_MAX - maxMercY) / (2 * MERC_MAX) * Math.pow(2, query.maxZoom));\r\n                    query.maxY = Math.floor((MERC_MAX - minMercY) / (2 * MERC_MAX) * Math.pow(2, query.maxZoom));\r\n                  }\r\n                }\r\n                break;\r\n              default:\r\n                retVal = 'Error: Unknown \"type\" value';\r\n            }\r\n          }\r\n          if (!retVal) {\r\n            if (!checkAttributes(query, ['maxX', 'minX', 'maxY', 'minY', 'minZoom', 'maxZoom'])) {\r\n              query.totalTile = 0;\r\n              const calcTileCoord = (atMaxZoom: number, zoom: number) => { return Math.floor(atMaxZoom / Math.pow(2, query.maxZoom - zoom)) };\r\n              for (let z = query.minZoom; z <= query.maxZoom; z++) {\r\n                const minX = calcTileCoord(query.minX, z);\r\n                const minY = calcTileCoord(query.minY, z);\r\n                const maxX = calcTileCoord(query.maxX, z);\r\n                const maxY = calcTileCoord(query.maxY, z);\r\n                query.totalTile += (maxX - minX + 1) * (maxY - minY + 1);\r\n              }\r\n            }\r\n            await putItem(db, 'mapSetting', query);\r\n            await getDB(`Weiwudi_${query.mapID}`, 'tileCache', 'z_x_y');\r\n            retVal = new Response(JSON.stringify(query), {\r\n              headers: new Headers({\r\n                'content-type': 'application/json'\r\n              })\r\n            });\r\n          }\r\n          break;\r\n        }\r\n        case 'clean':\r\n          retVal = checkAttributes(query, ['mapID']);\r\n          if (fetchAllBlocker && fetchAllBlocker.mapID == query.mapID) {\r\n            retVal = `Error: ${query.mapID} is under fetching process. Please cancel it first`;\r\n          } else if (!retVal) {\r\n            const cacheDB = await getDB(`Weiwudi_${query.mapID}`);\r\n            await cleanDB(cacheDB, 'tileCache');\r\n            retVal = `Cleaned: ${query.mapID}`;\r\n          }\r\n          break;\r\n        case 'delete':\r\n          retVal = checkAttributes(query, ['mapID']);\r\n          if (fetchAllBlocker && fetchAllBlocker.mapID == query.mapID) {\r\n            retVal = `Error: ${query.mapID} is under fetching process. Please cancel it first`;\r\n          } else if (!retVal) {\r\n            await deleteDB(`Weiwudi_${query.mapID}`);\r\n            const db = await getDB('Weiwudi');\r\n            await deleteItem(db, 'mapSetting', query.mapID);\r\n            retVal = `Deleted: ${query.mapID}`;\r\n          }\r\n          break;\r\n        case 'cancel':\r\n          retVal = checkAttributes(query, ['mapID']);\r\n          if (fetchAllBlocker && fetchAllBlocker.mapID == query.mapID) {\r\n            fetchAllBlocker.cancel = true;\r\n            retVal = `Fetching process of ${fetchAllBlocker.mapID} is canceled`;\r\n          } else {\r\n            retVal = `Error: There are no fetching process of ${query.mapID}`;\r\n          }\r\n          break;\r\n        case 'stats':\r\n          retVal = checkAttributes(query, ['mapID']);\r\n          if (!retVal) {\r\n            const db = await getDB('Weiwudi');\r\n            const setting = await getItem(db, 'mapSetting', query.mapID) as MapSetting;\r\n            if (!setting) retVal = `Error: MapID \"${query.mapID}\" not found`;\r\n            else {\r\n              const cacheDB = await getDB(`Weiwudi_${query.mapID}`);\r\n              const ret = await countDB(cacheDB, 'tileCache');\r\n              if (setting.totalTile) {\r\n                ret.total = setting.totalTile;\r\n                ret.percent = Math.floor(ret.count / ret.total! * 100);\r\n              }\r\n              retVal = new Response(JSON.stringify(ret), {\r\n                headers: new Headers({\r\n                  'content-type': 'application/json'\r\n                })\r\n              });\r\n            }\r\n          }\r\n          break;\r\n        case 'cache': {\r\n          const matched = restPath?.match(/^([^/]+)\\/(\\d+)\\/(\\d+)\\/(\\d+)$/);\r\n          if (matched) {\r\n            retVal = await getImage(matched[1], parseInt(matched[2]), parseInt(matched[3]), parseInt(matched[4]));\r\n          } else {\r\n            retVal = 'Error: \"cache\" api needs mapID, zoom, x, y settings';\r\n          }\r\n          break;\r\n        }\r\n        case 'fetchAll':\r\n          retVal = checkAttributes(query, ['mapID']);\r\n          if (!retVal && client) {\r\n            const db = await getDB('Weiwudi');\r\n            const setting = await getItem(db, 'mapSetting', query.mapID) as MapSetting;\r\n            if (!setting) retVal = `Error: MapID \"${query.mapID}\" not found`;\r\n            else if (!setting.totalTile) retVal = `Error: Map \"${query.mapID}\" cannot fetch all tiles`;\r\n            else if (fetchAllBlocker) {\r\n              retVal = `Error: Another fetching process is running: \"${fetchAllBlocker.mapID}\" (${fetchAllBlocker.count} / ${fetchAllBlocker.total})`;\r\n            } else {\r\n              setTimeout(() => {\r\n                fetchAllBlocker = {\r\n                  mapID: query.mapID,\r\n                  total: setting.totalTile || 0,\r\n                  count: 0,\r\n                  error: 0\r\n                };\r\n                fetchAll(client, setting);\r\n              }, 1);\r\n              retVal = `Fetching task start: ${query.mapID}`;\r\n            }\r\n          }\r\n          break;\r\n        default:\r\n          retVal = `Error: API ${apiName} not found`;\r\n      }\r\n    } catch (e) {\r\n      retVal = `Error: ${e}`;\r\n    }\r\n\r\n    if (retVal) return retVal;\r\n  };\r\n\r\n  registerRoute(/^https?:\\/\\/weiwudi.example.com/, handlerCb, 'GET');\r\n}","/// <reference lib=\"webworker\" />\r\nimport { Weiwudi_Internal } from \"./weiwudi_gw_logic\";\r\n\r\ndeclare const self: ServiceWorkerGlobalScope & {\r\n    workbox: {\r\n        routing: {\r\n            // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n            registerRoute: any;\r\n        }\r\n    }\r\n};\r\n\r\nWeiwudi_Internal(self.workbox.routing.registerRoute);"],"names":["Weiwudi_Internal","registerRoute","MERC_MAX","dbCache","fetchAllBlocker","extractTemplate","template","z","x","y","b64toBlob","b64Data","contentType","sliceSize","byteCharacters","byteArrays","offset","slice","byteNumbers","i","byteArray","getDB","dbname","table","key","resolve","reject","openDB","event","db","_error","e","deleteDB","deleteReq","_event","error","cleanDB","tx","clearReq","_e","countDB","cursorReq","count","size","cursor","getItem","dry","store","getReq","putItem","item","putReq","deleteItem","delReq","getAllKeys","handlerCb","url","fetchEvent","client","matched","query","obj","values","apiName","restPath","res","apiFunc","getImage","mapID","noOutput","outExtent","setting","factor","minXatZ","maxXatZ","minYatZ","maxYatZ","headers","blob","status","statusText","cacheDB","cached","nowEpoch","resp","val","fetchAll","processed","percent","allKeys","allTasks","minZoom","maxZoom","subTasks","promises","task","retVal","checkAttributes","targets","prev","target","calcZoom","v","lng2MercX","lng","lat2MercY","lat","maxMercX","minMercX","maxMercY","minMercY","calcTileCoord","atMaxZoom","zoom","minX","minY","maxX","maxY","ret"],"mappings":"4FAuDO,SAASA,EAAiBC,EAAsF,CAErH,MAAMC,EAAW,qBACXC,EAAkB,CAAA,EACxB,IAAIC,EAEJ,MAAMC,EAAkB,CAACC,EAAkBC,EAAWC,EAAWC,IAChDH,EAAS,QAAQ,MAAO,OAAOC,CAAC,CAAC,EAC7C,QAAQ,MAAO,OAAOC,CAAC,CAAC,EACxB,QAAQ,MAAO,OAAOC,CAAC,CAAC,EACxB,QAAQ,OAAQ,OAAO,KAAK,IAAI,EAAGF,CAAC,EAAIE,EAAI,CAAC,CAAC,EAG7CC,EAAY,CAACC,EAAiBC,EAAc,GAAIC,EAAY,MAAQ,CACxE,MAAMC,EAAiB,KAAKH,CAAO,EAC7BI,EAAa,CAAA,EAEnB,QAASC,EAAS,EAAGA,EAASF,EAAe,OAAQE,GAAUH,EAAW,CACxE,MAAMI,EAAQH,EAAe,MAAME,EAAQA,EAASH,CAAS,EAEvDK,EAAc,IAAI,MAAMD,EAAM,MAAM,EAC1C,QAASE,EAAI,EAAGA,EAAIF,EAAM,OAAQE,IAChCD,EAAYC,CAAC,EAAIF,EAAM,WAAWE,CAAC,EAGrC,MAAMC,EAAY,IAAI,WAAWF,CAAW,EAC5CH,EAAW,KAAKK,CAAS,CAC3B,CAGA,OADa,IAAI,KAAKL,EAAY,CAAE,KAAMH,EAAa,CAEzD,EACMS,EAAQ,MAAOC,EAAgBC,EAAgBC,IAC5C,IAAI,QAAQ,CAACC,EAASC,IAAW,CACtC,GAAI,CACF,GAAIvB,EAAQmB,CAAM,EAAGG,EAAQtB,EAAQmB,CAAM,CAAC,MACvC,CACH,MAAMK,EAAS,UAAU,KAAKL,CAAM,EACpCK,EAAO,gBAAkB,SAAUC,EAAO,CACxC,MAAMC,EAAMD,EAAM,OAA4B,OAC1CL,GAASC,GAAKK,EAAG,kBAAkBN,EAAO,CAAE,QAASC,EAAK,CAChE,EACAG,EAAO,UAAY,SAAUC,EAAO,CAClC,MAAMC,EAAMD,EAAM,OAA4B,OAC9CzB,EAAQmB,CAAM,EAAIO,EAClBJ,EAAQI,CAAE,CACZ,EACAF,EAAO,QAAU,SAAUG,EAAQ,CACjCJ,EAAOC,EAAO,KAAK,CACrB,CACF,CACF,OAASI,EAAG,CACVL,EAAOK,CAAC,CACV,CACF,CAAC,EAEGC,EAAW,MAAOV,IAClBnB,EAAQmB,CAAM,IACLnB,EAAQmB,CAAM,EACtB,MAAA,EACH,OAAOnB,EAAQmB,CAAM,GAEhB,IAAI,QAAQ,CAACG,EAASC,IAAW,CACtC,GAAI,CACF,MAAMO,EAAY,UAAU,eAAeX,CAAM,EAEjDW,EAAU,UAAY,MAAOC,GAAW,CACtCT,EAAA,CACF,EACAQ,EAAU,QAAU,SAAUE,EAAO,CACnCT,EAAOS,CAAK,CACd,CACF,OAASJ,EAAG,CACVL,EAAOK,CAAC,CACV,CACF,CAAC,GAEGK,EAAU,MAAOP,EAAiBN,IAC/B,IAAI,QAAQ,CAACE,EAASC,IAAW,CACtC,MAAMW,EAAKR,EAAG,YAAY,CAACN,CAAK,EAAG,WAAW,EAExCe,EADQD,EAAG,YAAYd,CAAK,EACX,MAAA,EACvBe,EAAS,UAAY,SAAUC,EAAI,CACnC,EACAD,EAAS,QAAU,SAAU,EAAG,CAC9BZ,EAAO,CAAC,CACV,EACAW,EAAG,WAAa,SAAUE,EAAI,CAC5Bd,EAAA,CACF,EACAY,EAAG,QAAU,SAAU,EAAG,CACxBX,EAAO,CAAC,CACV,EACAW,EAAG,QAAU,SAAU,EAAG,CACxBX,EAAO,CAAC,CACV,CACF,CAAC,EAEGc,EAAU,MAAOX,EAAiBN,IAC/B,IAAI,QAAQ,CAACE,EAASC,IAAW,CACtC,MAAMW,EAAKR,EAAG,YAAY,CAACN,CAAK,EAAG,UAAU,EAEvCkB,EADQJ,EAAG,YAAYd,CAAK,EACV,WAAA,EACxB,IAAImB,EAAQ,EACRC,EAAO,EACXF,EAAU,UAAY,SAAUF,EAAI,CAClC,MAAMK,EAASH,EAAU,OACrBG,IACFF,IACAC,EAAOA,EAAQC,EAAO,MAAM,KAAK,KACjCA,EAAO,SAAA,EAEX,EACAH,EAAU,QAAU,SAAUV,EAAG,CAC/BL,EAAOK,CAAC,CACV,EACAM,EAAG,WAAa,SAAUE,EAAI,CAC5Bd,EAAQ,CACN,MAAAiB,EACA,KAAAC,CAAA,CACD,CACH,EACAN,EAAG,QAAU,SAAUN,EAAG,CACxBL,EAAOK,CAAC,CACV,EACAM,EAAG,QAAU,SAAUN,EAAG,CACxBL,EAAOK,CAAC,CACV,CACF,CAAC,EAEGc,EAAU,MAAOhB,EAAiBN,EAAeC,EAAasB,IAC3D,IAAI,QAAQ,CAACrB,EAASC,IAAW,CACtC,MAAMW,EAAKR,EAAG,YAAY,CAACN,CAAK,EAAG,UAAU,EACvCwB,EAAQV,EAAG,YAAYd,CAAK,EAC5ByB,EAASF,EAAMC,EAAM,OAAOvB,CAAG,EAAIuB,EAAM,IAAIvB,CAAG,EACtDwB,EAAO,UAAY,SAAUT,EAAI,CACjC,EACAS,EAAO,QAAU,SAAUjB,EAAG,CAC5BL,EAAOK,CAAC,CACV,EACAM,EAAG,WAAa,SAAUE,EAAI,CAC5Bd,EAAQuB,EAAO,MAAM,CACvB,EACAX,EAAG,QAAU,SAAUN,EAAG,CACxBL,EAAOK,CAAC,CACV,EACAM,EAAG,QAAU,SAAUN,EAAG,CACxBL,EAAOK,CAAC,CACV,CACF,CAAC,EAEGkB,EAAU,MAAOpB,EAAiBN,EAAe2B,IAC9C,IAAI,QAAQ,CAACzB,EAASC,IAAW,CACtC,MAAMW,EAAKR,EAAG,YAAY,CAACN,CAAK,EAAG,WAAW,EAExC4B,EADQd,EAAG,YAAYd,CAAK,EACb,IAAI2B,CAAI,EAC7BC,EAAO,UAAY,SAAUZ,EAAI,CACjC,EACAY,EAAO,QAAU,SAAUpB,EAAG,CAC5BL,EAAOK,CAAC,CACV,EACAM,EAAG,WAAa,SAAUE,EAAI,CAC5Bd,EAAA,CACF,EACAY,EAAG,QAAU,SAAUN,EAAG,CACxBL,EAAOK,CAAC,CACV,EACAM,EAAG,QAAU,SAAUN,EAAG,CACxBL,EAAOK,CAAC,CACV,CACF,CAAC,EAEGqB,EAAa,MAAOvB,EAAiBN,EAAeC,IACjD,IAAI,QAAQ,CAACC,EAASC,IAAW,CACtC,MAAMW,EAAKR,EAAG,YAAY,CAACN,CAAK,EAAG,WAAW,EAExC8B,EADQhB,EAAG,YAAYd,CAAK,EACb,OAAOC,CAAG,EAC/B6B,EAAO,UAAY,SAAUd,EAAI,CACjC,EACAc,EAAO,QAAU,SAAUtB,EAAG,CAC5BL,EAAOK,CAAC,CACV,EACAM,EAAG,WAAa,SAAUE,EAAI,CAC5Bd,EAAA,CACF,EACAY,EAAG,QAAU,SAAUN,EAAG,CACxBL,EAAOK,CAAC,CACV,EACAM,EAAG,QAAU,SAAUN,EAAG,CACxBL,EAAOK,CAAC,CACV,CACF,CAAC,EAEGuB,EAAa,MAAOzB,EAAiBN,IAClC,IAAI,QAAQ,CAACE,EAASC,IAAW,CACtC,MAAMW,EAAKR,EAAG,YAAY,CAACN,CAAK,EAAG,WAAW,EAExCyB,EADQX,EAAG,YAAYd,CAAK,EACb,WAAA,EACrByB,EAAO,UAAY,SAAUT,EAAI,CACjC,EACAS,EAAO,QAAU,SAAU,EAAG,CAC5BtB,EAAO,CAAC,CACV,EACAW,EAAG,WAAa,SAAUE,EAAI,CAC5Bd,EAAQuB,EAAO,MAAM,CACvB,EACAX,EAAG,QAAU,SAAU,EAAG,CACxBX,EAAO,CAAC,CACV,EACAW,EAAG,QAAU,SAAU,EAAG,CACxBX,EAAO,CAAC,CACV,CACF,CAAC,EAEG6B,EAAkC,MAAO,CAAE,IAAAC,EAAK,MAAA5B,KAAY,CAChE,MAAM6B,EAAa7B,aAAiB,WAAaA,EAAQ,OACnD8B,EAASD,GAAcA,EAAW,SAAW,MAAM,KAAK,QAAQ,IAAIA,EAAW,QAAQ,EAAI,OAC3FE,EAAUH,EAAI,SAAS,MAAM,+BAA+B,EAClE,GAAIG,EAAS,CAEX,MAAMC,EAAQ,CAAC,GAAGJ,EAAI,aAAa,QAAA,CAAS,EAAE,OAAO,CAACK,EAAU9B,IAAM,CACpE,MAAM+B,EAASN,EAAI,aAAa,OAAOzB,EAAE,CAAC,CAAC,EAC3C,OAAI+B,EAAO,SAAW,EAAGD,EAAI9B,EAAE,CAAC,CAAC,EAAI+B,EAAO,CAAC,EACxCD,EAAI9B,EAAE,CAAC,CAAC,EAAI+B,EACVD,CACT,EAAG,CAAA,CAAE,EACCE,EAAUJ,EAAQ,CAAC,EACnBK,EAAWL,EAAQ,CAAC,EAC1B,IAAIM,EAAM,MAAMC,EAAQH,EAASH,EAAOI,EAAUN,CAAM,EACxD,GAAIO,EACF,OAAMA,aAAe,WAAWA,EAAM,IAAI,SAASA,CAAG,GAC/CA,CAEX,CACA,OAAO,IAAI,SAAS,YAAa,CAAE,OAAQ,IAAK,CAClD,EACME,EAAW,MAAOC,EAAe7D,EAAWC,EAAWC,EAAW4D,IAAuB,CAC7F,IAAIC,EACJ,MAAMzC,EAAK,MAAMR,EAAM,SAAS,EAC1BkD,EAAU,MAAM1B,EAAQhB,EAAI,aAAcuC,CAAK,EACrD,GAAI,CAACC,EAAU,CACb,GAAI,CAACE,EAAS,MAAO,iBAAiBH,CAAK,cAC3C,GAAI7D,GAAKgE,EAAQ,SAAW,IAAMhE,GAAKgE,EAAQ,SAAW,GAAID,EAAY,eACjEC,EAAQ,OAAS,QAAaA,EAAQ,OAAS,QAAaA,EAAQ,OAAS,QAAaA,EAAQ,OAAS,OAAW,CAC7H,MAAMC,EAAS,KAAK,IAAI,GAAID,EAAQ,SAAW,GAAKhE,CAAC,EAC/CkE,EAAU,KAAK,OAAOF,EAAQ,MAAQ,GAAKC,CAAM,EACjDE,EAAU,KAAK,OAAOH,EAAQ,MAAQ,GAAKC,CAAM,EACjDG,EAAU,KAAK,OAAOJ,EAAQ,MAAQ,GAAKC,CAAM,EACjDI,EAAU,KAAK,OAAOL,EAAQ,MAAQ,GAAKC,CAAM,GACnDhE,EAAIiE,GAAWjE,EAAIkE,GAAWjE,EAAIkE,GAAWlE,EAAImE,KAASN,EAAY,SAC5E,CACF,CACA,IAAIO,EAAkC,CAAA,EAClCC,EACAC,EAAS,IACTC,EAAa,KACjB,GAAIV,EACEA,IAAc,QAChBS,EAAS,IACTC,EAAa,cAEbH,EAAU,CACR,eAAgB,WAAA,EAElBC,EAAOpE,EAAU,+VAIiCmE,EAAQ,cAAc,CAAC,OAEtE,CACL,MAAMI,EAAU,MAAM5D,EAAM,WAAW+C,CAAK,EAAE,EACxCc,EAAS,MAAMrC,EAAQoC,EAAS,YAAa,GAAG1E,CAAC,IAAIC,CAAC,IAAIC,CAAC,GAAI4D,CAAQ,EACvEc,EAAW,IAAI,KAAA,EAAO,QAAA,EAC5B,GAAI,CAACD,GAAU,CAACA,EAAO,OAASC,EAAWD,EAAO,MAAQ,MAAU,CAElE,IAAI5E,EAAW,GACXiE,EAAQ,eAAe,MACzBjE,EAAWiE,EAAQ,IAAI,KAAK,MAAM,KAAK,SAAWA,EAAQ,IAAI,MAAM,CAAC,EAC5D,OAAOA,EAAQ,KAAQ,WAChCjE,EAAWiE,EAAQ,KAGrB,MAAMf,EAAMnD,EAAgBC,EAAUC,EAAGC,EAAGC,CAAC,EAC7C,GAAI,CACF,MAAM2E,EAAO,MAAM,MAAM5B,CAAG,EACxB4B,EAAK,IACPP,EAAU,CAAA,EACVO,EAAK,QAAQ,QAAQ,CAACC,EAAK7D,IAAQ,CAAEqD,EAAQrD,CAAG,EAAI6D,CAAK,CAAC,EAC1DP,EAAO,MAAMM,EAAK,KAAA,EAClB,MAAMnC,EAAQgC,EAAS,YAAa,CAClC,MAAS,GAAG1E,CAAC,IAAIC,CAAC,IAAIC,CAAC,GACvB,QAAAoE,EACA,KAAAC,EACA,MAAOK,CAAA,CACR,IAEGD,GACFL,EAAUK,EAAO,QACjBJ,EAAOI,EAAO,OAEdH,EAASK,EAAK,OACdJ,EAAaI,EAAK,WAClBP,EAAU,CAAA,EACVO,EAAK,QAAQ,QAAQ,CAACC,EAAK7D,IAAQ,CAAEqD,EAAQrD,CAAG,EAAI6D,CAAK,CAAC,EAC1DP,EAAO,MAAMM,EAAK,KAAA,GAEhBhF,GAAiBA,EAAgB,QAEzC,MAAa,CACP8E,GACFL,EAAUK,EAAO,QACjBJ,EAAOI,EAAO,OAEdH,EAAS,IACTC,EAAa,aAEX5E,GAAiBA,EAAgB,OACvC,CACF,MAAYiE,IACVQ,EAAUK,EAAO,QACjBJ,EAAOI,EAAO,KAElB,CACA,OAAOb,EAAW,OAAY,IAAI,SAASS,EAAM,CAC/C,OAAAC,EACA,WAAAC,EACA,QAAS,IAAI,QAAQH,CAAO,CAAA,CAC7B,CACH,EACMS,EAAW,MAAO5B,EAAgBa,IAAwB,CAC9D,IAAIgB,EAAY,EACZC,EAAU,EACd,MAAM3D,EAAK,MAAMR,EAAM,WAAWkD,EAAQ,KAAK,EAAE,EAC3CkB,EAAU,MAAMnC,EAAWzB,EAAI,WAAW,EAChD,GAAI,CACF,MAAM6D,EAAW,CAAA,EACXC,EAAUpB,EAAQ,SAAW,EAC7BqB,EAAUrB,EAAQ,SAAW,EACnC,QAAShE,EAAIoF,EAASpF,GAAKqF,EAASrF,IAAK,CACvC,MAAMiE,EAAS,KAAK,IAAI,EAAGoB,EAAUrF,CAAC,EAChCmE,EAAU,KAAK,OAAOH,EAAQ,MAAQ,GAAKC,CAAM,EACjDC,EAAU,KAAK,OAAOF,EAAQ,MAAQ,GAAKC,CAAM,EACjDI,EAAU,KAAK,OAAOL,EAAQ,MAAQ,GAAKC,CAAM,EACjDG,EAAU,KAAK,OAAOJ,EAAQ,MAAQ,GAAKC,CAAM,EACvD,QAAShE,EAAIiE,EAASjE,GAAKkE,EAASlE,IAClC,QAASC,EAAIkE,EAASlE,GAAKmE,EAASnE,IAClCiF,EAAS,KAAK,CAACnF,EAAGC,EAAGC,CAAC,CAAC,CAG7B,CACIiF,EAAS,QAAUnB,EAAQ,WAAW,QAAQ,IAAI,8BAA8B,EACpF,IAAIsB,EAAWH,EAAS,OAAO,EAAG,CAAC,EACnC,KAAOG,EAAS,QAAQ,CAGtB,GAAI,CADgB,MAAM,KAAK,QAAQ,IAAInC,EAAO,EAAE,EAClC,CAChBtD,EAAkB,OAClB,MACF,CACA,GAAIA,GAAmBA,EAAgB,OAAQ,CAC7CA,EAAkB,OAClBsD,EAAO,YAAY,CACjB,KAAM,WACN,QAAS,oBAAoBa,EAAQ,KAAK,eAC1C,MAAOA,EAAQ,KAAA,CAChB,EACD,MACF,CACA,MAAMuB,EAAWD,EAAS,IAAKE,GAAS,CACtC,GAAI,EAAAN,EAAQ,QAAQ,GAAGM,EAAK,CAAC,CAAC,IAAIA,EAAK,CAAC,CAAC,IAAIA,EAAK,CAAC,CAAC,EAAE,GAAK,GAC3D,OAAO5B,EAASI,EAAQ,MAAOwB,EAAK,CAAC,EAAGA,EAAK,CAAC,EAAGA,EAAK,CAAC,EAAG,EAAI,CAChE,CAAC,EACD,MAAM,QAAQ,IAAID,CAAQ,EAC1BP,GAAaO,EAAS,OAClB1F,MAAiC,MAAQmF,GAC7CC,EAAU,KAAK,MAAMD,EAAY,KAAOhB,EAAQ,WAAa,EAAE,EAC/Db,EAAO,YAAY,CACjB,KAAM,UACN,QAAS,iCAAiCa,EAAQ,KAAK,IAAIiB,CAAO,MAAMD,CAAS,MAAMhB,EAAQ,SAAS,IACxG,QAAAiB,EACA,UAAAD,EACA,MAAOnF,EAAkBA,EAAgB,MAAQ,EACjD,MAAOmE,EAAQ,UACf,MAAOA,EAAQ,KAAA,CAChB,EACDsB,EAAWH,EAAS,OAAO,EAAG,CAAC,CACjC,CACA,MAAMvD,EAAQ/B,EAAkBA,EAAgB,MAAQ,EACxDA,EAAkB,OAClBsD,EAAO,YAAY,CACjB,KAAM,SACN,QAAS,wBAAwBa,EAAQ,KAAK,GAAGpC,EAAQ,SAASA,CAAK,eAAiB,EAAE,GAC1F,MAAOoC,EAAQ,UACf,MAAOA,EAAQ,MACf,MAAApC,CAAA,CACD,CACH,OAASJ,EAAG,CACV3B,EAAkB,OAClBsD,EAAO,YAAY,CACjB,KAAM,OACN,QAAS,qBAAqBa,EAAQ,KAAK,IAAIgB,CAAS,MAAMhB,EAAQ,SAAS,GAC/E,OAAQxC,EACR,UAAAwD,EACA,MAAOhB,EAAQ,UACf,MAAOA,EAAQ,KAAA,CAChB,CACH,CACF,EAEML,EAAU,MAAOH,EAAiBH,EAAYI,EAA8BN,IAAoB,CAEpG,IAAIsC,EAEJ,MAAMC,EAAkB,CAACrC,EAAYsC,IAC5BA,EAAQ,OAAO,CAACC,EAA0BC,IAC3CD,IACAvC,EAAMwC,CAAM,IAAM,OAAkB,qBAAqBA,CAAM,eAC5DD,GACN,MAAS,EAEd,GAAI,CACF,OAAQpC,EAAA,CACN,IAAK,OACHiC,EAAS,cACT,MACF,IAAK,OAEH,GADAA,EAASC,EAAgBrC,EAAO,CAAC,OAAO,CAAC,EACrC,CAACoC,EAAQ,CACX,MAAMnE,EAAK,MAAMR,EAAM,UAAW,aAAc,OAAO,EACjDkD,EAAU,MAAM1B,EAAQhB,EAAI,aAAc+B,EAAM,KAAK,EACtDW,EAEHyB,EAAS,IAAI,SAAS,KAAK,UAAUzB,CAAO,EAAG,CAC7C,QAAS,IAAI,QAAQ,CACnB,eAAgB,kBAAA,CACjB,CAAA,CACF,EANWyB,EAAS,iBAAiBpC,EAAM,KAAK,aAQrD,CACA,MACF,IAAK,MAAO,CACV,MAAM/B,EAAK,MAAMR,EAAM,UAAW,aAAc,OAAO,EAEvD,GADA2E,EAASC,EAAgBrC,EAAO,CAAC,QAAS,OAAQ,KAAK,CAAC,EACpD,CAACoC,EAEH,OADApC,EAAM,SAAW,SAASA,EAAM,UAAY,GAAG,EACvCA,EAAM,KAAA,CACZ,IAAK,MAEH,GADAoC,EAASC,EAAgBrC,EAAO,CAAC,QAAS,QAAQ,CAAC,EAC/C,CAACoC,EAAQ,CACXpC,EAAM,MAAQ,SAASA,EAAM,KAAK,EAClCA,EAAM,OAAS,SAASA,EAAM,MAAM,EACpC,MAAMyC,EAAYC,GAAuB,KAAK,KAAK,KAAK,IAAIA,EAAI1C,EAAM,QAAQ,EAAI,KAAK,IAAI,CAAC,CAAC,EAC7FA,EAAM,QAAU,KAAK,IAAIyC,EAASzC,EAAM,KAAK,EAAGyC,EAASzC,EAAM,MAAM,CAAC,EACtEA,EAAM,QAAUA,EAAM,QAAU,SAASA,EAAM,OAAO,EAAI,EAC1DA,EAAM,KAAO,EACbA,EAAM,KAAO,EACbA,EAAM,KAAO,KAAK,KAAKA,EAAM,MAAQA,EAAM,QAAQ,EAAI,EACvDA,EAAM,KAAO,KAAK,KAAKA,EAAM,OAASA,EAAM,QAAQ,EAAI,CAC1D,CACA,MACF,IAAK,OACH,GAAI,CAACoC,EAAQ,CACX,MAAMO,EAAaC,GAAyB,QAAUA,EAAM,KAAK,GAAK,IAChEC,EAAaC,GAAyB,QAAU,KAAK,IAAI,KAAK,IAAI,KAAK,GAAK,KAAO,GAAKA,EAAI,CAAC,EAGnG,GAFI9C,EAAM,UAASA,EAAM,QAAU,SAASA,EAAM,OAAO,GACrDA,EAAM,UAASA,EAAM,QAAU,SAASA,EAAM,OAAO,GACrDA,EAAM,QAAUA,EAAM,QAAUA,EAAM,QAAUA,EAAM,OAAQ,CAChEA,EAAM,OAAS,WAAWA,EAAM,MAAM,EACtCA,EAAM,OAAS,WAAWA,EAAM,MAAM,EACtCA,EAAM,OAAS,WAAWA,EAAM,MAAM,EACtCA,EAAM,OAAS,WAAWA,EAAM,MAAM,EACtC,MAAM+C,EAAWJ,EAAU3C,EAAM,MAAM,EACjCgD,EAAWL,EAAU3C,EAAM,MAAM,EACjCiD,EAAWJ,EAAU7C,EAAM,MAAM,EACjCkD,EAAWL,EAAU7C,EAAM,MAAM,EACvCA,EAAM,KAAO,KAAK,OAAO1D,EAAW0G,IAAa,EAAI1G,GAAY,KAAK,IAAI,EAAG0D,EAAM,OAAO,CAAC,EAC3FA,EAAM,KAAO,KAAK,OAAO1D,EAAWyG,IAAa,EAAIzG,GAAY,KAAK,IAAI,EAAG0D,EAAM,OAAO,CAAC,EAC3FA,EAAM,KAAO,KAAK,OAAO1D,EAAW2G,IAAa,EAAI3G,GAAY,KAAK,IAAI,EAAG0D,EAAM,OAAO,CAAC,EAC3FA,EAAM,KAAO,KAAK,OAAO1D,EAAW4G,IAAa,EAAI5G,GAAY,KAAK,IAAI,EAAG0D,EAAM,OAAO,CAAC,CAC7F,CACF,CACA,MACF,QACEoC,EAAS,6BAAA,CAGf,GAAI,CAACA,EAAQ,CACX,GAAI,CAACC,EAAgBrC,EAAO,CAAC,OAAQ,OAAQ,OAAQ,OAAQ,UAAW,SAAS,CAAC,EAAG,CACnFA,EAAM,UAAY,EAClB,MAAMmD,EAAgB,CAACC,EAAmBC,IAA0B,KAAK,MAAMD,EAAY,KAAK,IAAI,EAAGpD,EAAM,QAAUqD,CAAI,CAAC,EAC5H,QAAS1G,EAAIqD,EAAM,QAASrD,GAAKqD,EAAM,QAASrD,IAAK,CACnD,MAAM2G,EAAOH,EAAcnD,EAAM,KAAMrD,CAAC,EAClC4G,EAAOJ,EAAcnD,EAAM,KAAMrD,CAAC,EAClC6G,EAAOL,EAAcnD,EAAM,KAAMrD,CAAC,EAClC8G,EAAON,EAAcnD,EAAM,KAAMrD,CAAC,EACxCqD,EAAM,YAAcwD,EAAOF,EAAO,IAAMG,EAAOF,EAAO,EACxD,CACF,CACA,MAAMlE,EAAQpB,EAAI,aAAc+B,CAAK,EACrC,MAAMvC,EAAM,WAAWuC,EAAM,KAAK,GAAI,YAAa,OAAO,EAC1DoC,EAAS,IAAI,SAAS,KAAK,UAAUpC,CAAK,EAAG,CAC3C,QAAS,IAAI,QAAQ,CACnB,eAAgB,kBAAA,CACjB,CAAA,CACF,CACH,CACA,KACF,CACA,IAAK,QAEH,GADAoC,EAASC,EAAgBrC,EAAO,CAAC,OAAO,CAAC,EACrCxD,GAAmBA,EAAgB,OAASwD,EAAM,MACpDoC,EAAS,UAAUpC,EAAM,KAAK,6DACrB,CAACoC,EAAQ,CAClB,MAAMf,EAAU,MAAM5D,EAAM,WAAWuC,EAAM,KAAK,EAAE,EACpD,MAAMxB,EAAQ6C,EAAS,WAAW,EAClCe,EAAS,YAAYpC,EAAM,KAAK,EAClC,CACA,MACF,IAAK,SAEH,GADAoC,EAASC,EAAgBrC,EAAO,CAAC,OAAO,CAAC,EACrCxD,GAAmBA,EAAgB,OAASwD,EAAM,MACpDoC,EAAS,UAAUpC,EAAM,KAAK,6DACrB,CAACoC,EAAQ,CAClB,MAAMhE,EAAS,WAAW4B,EAAM,KAAK,EAAE,EACvC,MAAM/B,EAAK,MAAMR,EAAM,SAAS,EAChC,MAAM+B,EAAWvB,EAAI,aAAc+B,EAAM,KAAK,EAC9CoC,EAAS,YAAYpC,EAAM,KAAK,EAClC,CACA,MACF,IAAK,SACHoC,EAASC,EAAgBrC,EAAO,CAAC,OAAO,CAAC,EACrCxD,GAAmBA,EAAgB,OAASwD,EAAM,OACpDxD,EAAgB,OAAS,GACzB4F,EAAS,uBAAuB5F,EAAgB,KAAK,gBAErD4F,EAAS,2CAA2CpC,EAAM,KAAK,GAEjE,MACF,IAAK,QAEH,GADAoC,EAASC,EAAgBrC,EAAO,CAAC,OAAO,CAAC,EACrC,CAACoC,EAAQ,CACX,MAAMnE,EAAK,MAAMR,EAAM,SAAS,EAC1BkD,EAAU,MAAM1B,EAAQhB,EAAI,aAAc+B,EAAM,KAAK,EAC3D,GAAI,CAACW,EAASyB,EAAS,iBAAiBpC,EAAM,KAAK,kBAC9C,CACH,MAAMqB,EAAU,MAAM5D,EAAM,WAAWuC,EAAM,KAAK,EAAE,EAC9C0D,EAAM,MAAM9E,EAAQyC,EAAS,WAAW,EAC1CV,EAAQ,YACV+C,EAAI,MAAQ/C,EAAQ,UACpB+C,EAAI,QAAU,KAAK,MAAMA,EAAI,MAAQA,EAAI,MAAS,GAAG,GAEvDtB,EAAS,IAAI,SAAS,KAAK,UAAUsB,CAAG,EAAG,CACzC,QAAS,IAAI,QAAQ,CACnB,eAAgB,kBAAA,CACjB,CAAA,CACF,CACH,CACF,CACA,MACF,IAAK,QAAS,CACZ,MAAM3D,EAAUK,GAAU,MAAM,gCAAgC,EAC5DL,EACFqC,EAAS,MAAM7B,EAASR,EAAQ,CAAC,EAAG,SAASA,EAAQ,CAAC,CAAC,EAAG,SAASA,EAAQ,CAAC,CAAC,EAAG,SAASA,EAAQ,CAAC,CAAC,CAAC,EAEpGqC,EAAS,sDAEX,KACF,CACA,IAAK,WAEH,GADAA,EAASC,EAAgBrC,EAAO,CAAC,OAAO,CAAC,EACrC,CAACoC,GAAUtC,EAAQ,CACrB,MAAM7B,EAAK,MAAMR,EAAM,SAAS,EAC1BkD,EAAU,MAAM1B,EAAQhB,EAAI,aAAc+B,EAAM,KAAK,EACtDW,EACKA,EAAQ,UACTnE,EACP4F,EAAS,gDAAgD5F,EAAgB,KAAK,MAAMA,EAAgB,KAAK,MAAMA,EAAgB,KAAK,KAEpI,WAAW,IAAM,CACfA,EAAkB,CAChB,MAAOwD,EAAM,MACb,MAAOW,EAAQ,WAAa,EAC5B,MAAO,EACP,MAAO,CAAA,EAETe,EAAS5B,EAAQa,CAAO,CAC1B,EAAG,CAAC,EACJyB,EAAS,wBAAwBpC,EAAM,KAAK,IAbjBoC,EAAS,eAAepC,EAAM,KAAK,2BADlDoC,EAAS,iBAAiBpC,EAAM,KAAK,aAgBrD,CACA,MACF,QACEoC,EAAS,cAAcjC,CAAO,YAAA,CAEpC,OAAShC,EAAG,CACViE,EAAS,UAAUjE,CAAC,EACtB,CAEA,GAAIiE,EAAQ,OAAOA,CACrB,EAEA/F,EAAc,kCAAmCsD,EAAW,KAAK,CACnE,CCtoBAvD,EAAiB,KAAK,QAAQ,QAAQ,aAAa"}